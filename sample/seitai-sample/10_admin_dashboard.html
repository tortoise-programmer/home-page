<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理画面ダッシュボード</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.20/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* サイドバーのアクティブ状態をカスタマイズ */
        .menu li > a.menu-active {
            background-color: rgb(59 130 246 / 0.1) !important;
            color: rgb(59 130 246) !important;
            border-right: 2px solid rgb(59 130 246);
            font-weight: 600;
        }
        
        .menu li > a:hover:not(.menu-active) {
            background-color: rgb(0 0 0 / 0.05);
        }
        
        /* スケジュールテーブルの統一スタイル */
        .schedule-table {
            table-layout: fixed;
            width: 100%;
        }
        
        .schedule-table th:first-child,
        .schedule-table td:first-child {
            width: 80px;
            min-width: 80px;
        }
        
        .schedule-table th:not(:first-child),
        .schedule-table td:not(:first-child) {
            width: 150px;
            min-width: 150px;
        }
        /* 月表示専用: 7列を均等化し横幅崩れを防止 */
        .schedule-table.month-mode { table-layout: fixed; width: 100%; }
        .schedule-table.month-mode thead th,
        .schedule-table.month-mode tbody td { width: calc(100% / 7) !important; }
        /* 月表示: 日付と予定が重ならないようレイアウト調整 */
        .schedule-table.month-mode tbody td { position: relative; }
        .schedule-table.month-mode .day-number { position: absolute; top: 6px; right: 8px; font-size: 12px; font-weight: 600; opacity: 0.8; pointer-events: none; }
        .schedule-table.month-mode .day-content { margin-top: 1.25rem; }
        
        /* 予約カードとスロットの統一サイズ */
        .reservation-card,
        .empty-slot {
            min-height: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .reservation-card {
            padding: 8px !important;
        }
        
        .empty-slot {
            padding: 8px !important;
        }
        
        /* 担当者別色分け */
        .staff-tanaka { background-color: #10b981; color: white; }
        .staff-yamada { background-color: #3b82f6; color: white; }
        .staff-sato { background-color: #8b5cf6; color: white; }
        .staff-suzuki { background-color: #f59e0b; color: white; }
        .staff-equipment { background-color: #6b7280; color: white; }
        
        
        /* スケジュールカードのスタイル */
        .schedule-card {
            min-height: 80px;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            text-align: left;
        }
        
        .schedule-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        
        .schedule-card .edit-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .schedule-card:hover .edit-icon {
            opacity: 1;
        }

        /* 担当者別の色分け */
        .staff-tanaka {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .staff-yamada {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .staff-sato {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .staff-suzuki {
            background: linear-gradient(135deg, #eab308, #ca8a04);
            color: white;
        }

        .staff-equipment {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        /* Notion風：時間グリッド（薄い横線） */
        .time-cell {
            height: 120px;
            width: 100%;
            border-radius: 6px;
            position: relative;
            cursor: pointer;
            /* 12.5%毎に薄い線 → 約7.5分間隔の目安線 */
            background-image: repeating-linear-gradient(
                to bottom,
                rgba(0, 0, 0, 0.06) 0px,
                rgba(0, 0, 0, 0.06) 1px,
                transparent 1px,
                transparent 12.5%
            );
            transition: background-color 0.15s ease;
        }
        /* hover効果は不要 */

        /* 任意長イベント描画 */
        .day-hour-cell { position: relative; height: 120px; }
        .event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 6px;
            color: #fff;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 12px;
            overflow: hidden;
        }
        .reservation-card { text-align: left; }
        
        /* 問診票：人体クリックマップ */
        .symptoms-input input[type="checkbox"] { display: none; }
        .symptoms-input .img-center { position: relative; }
        .symptoms-input .pos {
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(59,130,246,0.15);
            border: 1px solid rgba(59,130,246,0.6);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        /* 既存の固定〇は非表示にする */
        .symptoms-input .pos { display: none !important; }
        /* 任意クリックで追加するマーカー */
        .symptoms-input .marker {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(34,197,94,0.95);
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.25);
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        /* 問診票詳細フォームの余白調整 */
        #questionnaireDetailContent .label { padding: 0; min-height: 0; gap: 6px; }
        #questionnaireDetailContent .ml-2 { margin-left: 6px !important; }
        #questionnaireDetailContent .flex.gap-4 { gap: 8px !important; }
        #questionnaireDetailContent .flex.gap-3 { gap: 8px !important; }
        #questionnaireDetailContent .text-sm { line-height: 1.4; }
        #questionnaireDetailContent input.radio { vertical-align: middle; }
        #questionnaireDetailContent .pain-scale .btn { min-width: 40px; min-height: 40px; padding: 0; }
        #questionnaireDetailContent .pain-scale { gap: 8px; }
        .symptoms-input input[type="checkbox"]:checked + label.pos {
            background: rgba(34,197,94,0.9);
            border-color: rgba(34,197,94,1);
        }
        .symptoms-input .clickable { width: 345px; height: 345px; user-select: none; top: 0; left: 0; pointer-events: none; display: block; }
        
    </style>
</head>
<body class="bg-base-200 min-h-screen">
    <div class="drawer lg:drawer-open">
        <input id="drawer-toggle" type="checkbox" class="drawer-toggle" />
        
        <!-- サイドバー -->
        <div class="drawer-side">
            <label for="drawer-toggle" aria-label="close sidebar" class="drawer-overlay"></label>
            <aside class="min-h-full w-64 bg-base-100 shadow-lg">
                <!-- ロゴ・タイトル -->
                <div class="p-4 border-b border-base-300">
                    <div class="flex items-center gap-3">
                        <span class="fa-stack text-primary text-2xl">
                            <i class="fas fa-circle fa-stack-2x"></i>
                            <i class="fas fa-hand-holding-medical fa-stack-1x fa-inverse"></i>
                        </span>
                        <h1 class="text-xl font-bold">管理画面</h1>
                    </div>
                </div>
                
                <!-- メニュー（簡素化） -->
                <ul class="menu p-4 space-y-2">
                    <li>
                        <a href="#" class="menu-active" onclick="showDashboard()">
                            <i class="fas fa-chart-line"></i>
                            ダッシュボード
                        </a>
                    </li>
                    <li>
                        <details class="group">
                            <summary class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-200 cursor-pointer">
                                <i class="fas fa-users"></i>
                                <span>顧客管理</span>
                            </summary>
                            <ul class="ml-6 mt-2 space-y-1">
                                <li>
                                    <a href="#" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200" onclick="showCustomerInfo()">
                                        <i class="fas fa-user-circle text-sm"></i>
                                        顧客情報
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200" onclick="showReceptionList()">
                                        <i class="fas fa-clipboard-list text-sm"></i>
                                        受付一覧
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200" onclick="showScheduleManagement()">
                                        <i class="fas fa-calendar-week text-sm"></i>
                                        スケジュール管理
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200" onclick="showReviews()">
                                        <i class="fas fa-star text-sm"></i>
                                        口コミ
                                    </a>
                                </li>
                            </ul>
                        </details>
                    </li>
                    <li>
                        <details class="group">
                            <summary class="flex items-center gap-3 p-3 rounded-lg hover:bg-base-200 cursor-pointer">
                                <i class="fas fa-cog"></i>
                                <span>設定</span>
                            </summary>
                            <ul class="ml-6 mt-2 space-y-1">
                                <li>
                                    <a href="settings.html#sec-clinic" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200">
                                        <i class="fas fa-store text-sm"></i>
                                        店舗・治療院設定
                                    </a>
                                </li>
                                <li>
                                    <a href="settings.html#sec-clinic-info" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200">
                                        <i class="fas fa-info-circle text-sm"></i>
                                        店舗・治療院情報
                                    </a>
                                </li>
                                <li>
                                    <a href="settings.html#sec-providers" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200">
                                        <i class="fas fa-hand-holding-medical text-sm"></i>
                                        サービス提供者
                                    </a>
                                </li>
                                <li>
                                    <a href="settings.html#sec-menu" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200">
                                        <i class="fas fa-list text-sm"></i>
                                        メニュー管理
                                    </a>
                                </li>
                                <li>
                                    <a href="settings.html#sec-questionnaires" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200">
                                        <i class="fas fa-file-alt text-sm"></i>
                                        問診票一覧
                                    </a>
                                </li>
                            </ul>
                        </details>
                    </li>
                </ul>
        
        <!-- 簡素化: 上記の個別メニューは削除し、必要最小限に集約（ダッシュボード/顧客管理/店舗・治療院設定） -->
                
                <!-- ユーザー情報 -->
                <div class="absolute bottom-4 left-4 right-4">
                    <div class="dropdown dropdown-top w-full">
                        <div tabindex="0" role="button" class="btn btn-ghost w-full justify-start">
                            <i class="fas fa-user-circle text-xl"></i>
                            <span>管理者</span>
                            <i class="fas fa-chevron-up ml-auto"></i>
                        </div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-full mb-2">
                            <li><a href="#"><i class="fas fa-user mr-2"></i>プロフィール</a></li>
                            <li><a href="#"><i class="fas fa-sign-out-alt mr-2"></i>ログアウト</a></li>
                        </ul>
                    </div>
                </div>
            </aside>
        </div>
        
        <!-- メインコンテンツ -->
        <div class="drawer-content">
            <!-- モバイル用ヘッダー -->
            <div class="navbar bg-base-100 shadow-sm lg:hidden">
                <div class="navbar-start">
                    <label for="drawer-toggle" class="btn btn-square btn-ghost">
                        <i class="fas fa-bars text-xl"></i>
                    </label>
                </div>
                <div class="navbar-center">
                    <span class="text-lg font-semibold">ダッシュボード</span>
                </div>
                <div class="navbar-end">
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle">
                            <i class="fas fa-user-circle text-xl"></i>
                        </div>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                            <li><a href="#"><i class="fas fa-user mr-2"></i>プロフィール</a></li>
                            <li><a href="#"><i class="fas fa-sign-out-alt mr-2"></i>ログアウト</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- メインコンテンツエリア -->
            <div class="p-4 lg:p-6">
                <!-- 店舗・治療院情報（表示用） -->
                <div id="clinicInfoContent" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h1 class="text-2xl font-bold">表示・店舗・治療院管理</h1>
                    </div>
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <div class="grid grid-cols-1 gap-3">
                                <div class="bg-base-200 p-3 rounded">店舗カテゴリ<br><span class="text-sm">リラク・整体</span></div>
                                <div class="bg-base-200 p-3 rounded">店舗・治療院名<br><span class="text-sm">REBO</span></div>
                                <div class="bg-base-200 p-3 rounded">店舗・治療院名（カナ）<br><span class="text-sm">レボ</span></div>
                                <div class="bg-base-200 p-3 rounded">代表メールアドレス<br><span class="text-sm">seitai@renipro.jp</span></div>
                                <div class="bg-base-200 p-3 rounded">店舗・治療院の連絡先電話番号<br><span class="text-sm">0120987441</span></div>
                                <div class="bg-base-200 p-3 rounded">店舗ロゴ<br><span class="text-sm">—</span></div>
                                <div class="bg-base-200 p-3 rounded">営業時間<br><span class="text-sm">10:00〜21:00</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- サービス提供者（一覧） -->
                <div id="serviceProvidersContent" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h1 class="text-2xl font-bold">サービス提供者</h1>
                        <button class="btn btn-info btn-sm" onclick="openNewProviderModal()"><i class="fas fa-plus mr-1"></i>新規登録する</button>
                    </div>
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body p-4">
                            <div class="flex items-center gap-2 mb-4">
                                <input class="input input-bordered w-64" placeholder="名前" />
                                <button class="btn btn-primary btn-sm"><i class="fas fa-search mr-1"></i>検索する</button>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <div class="avatar"><div class="w-10 h-10 rounded-full bg-base-300"></div></div>
                                        <div class="text-sm">
                                            <div class="font-semibold">岩崎</div>
                                            <div class="opacity-70">申請中</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-info btn-xs">詳細を表示</button>
                                        <button class="btn btn-success btn-xs">編集する</button>
                                        <button class="btn btn-error btn-xs"><i class="fas fa-trash mr-1"></i>削除する</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <div class="avatar"><div class="w-10 h-10 rounded-full bg-base-300"></div></div>
                                        <div class="text-sm">
                                            <div class="font-semibold">電磁パルストレーニングチェア「ビジリス」BJIRIS</div>
                                            <div class="opacity-70">申請中</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-info btn-xs">詳細を表示</button>
                                        <button class="btn btn-success btn-xs">編集する</button>
                                        <button class="btn btn-error btn-xs"><i class="fas fa-trash mr-1"></i>削除する</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ダッシュボードコンテンツ -->
                <div id="dashboardContent">
                    <!-- 期間選択とリリース情報 -->
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <div class="badge badge-warning">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                2025年
                            </div>
                            <div class="text-sm text-base-content/70">
                                07月01日〜07月31日
                            </div>
                        </div>
                        <div class="flex items-end gap-4">
                            <button class="btn btn-ghost btn-sm">
                                <i class="fas fa-chevron-left mr-1"></i>
                                前月へ
                            </button>
                            <button class="btn btn-ghost btn-sm">
                                次月へ
                                <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>

        <!-- 統計カード -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- 来店数 -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="card-title text-sm text-base-content/70">来店数（カルテ数）</h2>
                            <div class="flex items-center gap-2 mt-2">
                                <i class="fas fa-info-circle text-info"></i>
                                <div class="text-2xl font-bold">今月: 94名</div>
                            </div>
                            <div class="text-sm text-base-content/70 mt-1">今日: 6名</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 受付中ステータス -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="card-title text-sm text-base-content/70">受付中ステータス</h2>
                            <div class="flex items-center gap-2 mt-2">
                                <i class="fas fa-info-circle text-info"></i>
                                <div class="text-2xl font-bold">36件</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新規・リピート -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="card-title text-sm text-base-content/70">新規・リピート</h2>
                            <div class="flex items-center gap-2 mt-2">
                                <i class="fas fa-info-circle text-info"></i>
                                <div class="text-sm">新規: 15名</div>
                            </div>
                            <div class="text-sm text-base-content/70 mt-1">リピート: 56名</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- グラフセクション -->
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-6 mb-8">
            <!-- 来店数グラフ -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title">今月総来店数（名）</h2>
                        <button class="btn btn-success btn-sm">
                            <i class="fas fa-download mr-1"></i>
                            来店データダウンロード
                        </button>
                    </div>
                    <div class="w-full h-96">
                        <canvas id="visitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 円グラフセクション -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- メニュー別 -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">メニュー別</h2>
                    <div class="w-full h-80">
                        <canvas id="menuChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
                            <span>基本整体コース（30分）</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-sky-400 rounded-full"></div>
                            <span>スタンダード整体コース（60分）</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-orange-400 rounded-full"></div>
                            <span>プレミアム整体コース（90分）</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                            <span>フルボディケアコース（120分）</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-purple-400 rounded-full"></div>
                            <span>初回限定お試しコース（60分）</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 年齢別 -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">年齢別</h2>
                    <div class="w-full h-80">
                        <canvas id="ageChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
                            <span>未記入</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-sky-400 rounded-full"></div>
                            <span>0〜9歳</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-orange-400 rounded-full"></div>
                            <span>10〜19歳</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                            <span>20〜29歳</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-purple-400 rounded-full"></div>
                            <span>30〜39歳</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span>40〜49歳</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-indigo-500 rounded-full"></div>
                            <span>50〜59歳</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-cyan-400 rounded-full"></div>
                            <span>60歳〜</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新規顧客分析 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 流入経路別 -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">新規数顧客数に対する流入経路別割合</h2>
                    <div class="w-full h-80">
                        <canvas id="inflowChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
                            <span>未記入</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 症状別 -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">新規数顧客数に対する症状お悩み別割合</h2>
                    <div class="w-full h-80">
                        <canvas id="symptomsChart"></canvas>
                    </div>
                    <div class="mt-4 space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full"></div>
                            <span>未記入 100.0% (15)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- サービス提供者とスポンサー -->
        <div class="space-y-6">
            <!-- サービス提供者 -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="card-title">サービス提供者</h2>
                        <button class="btn btn-info btn-sm" onclick="openNewProviderModal()">
                            <i class="fas fa-plus mr-1"></i>
                            新規登録する
                        </button>
                    </div>
                    
                    <!-- サービス提供者リスト -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
                            <div class="flex items-center gap-4">
                                <div class="avatar">
                                    <div class="w-12 h-12 rounded-full bg-base-300 flex items-center justify-center">
                                        <i class="fas fa-dumbbell text-lg text-base-content flex w-full h-full items-center justify-center"></i>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold">トレーニング機器A</h3>
                                </div>
                            </div>
                            <div class="flex items-center gap-8 text-center">
                                <div>
                                    <div class="text-2xl font-bold">15</div>
                                    <div class="text-xs text-base-content/70">登録顧客数</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold">12</div>
                                    <div class="text-xs text-base-content/70">今月のカルテ数</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold">0</div>
                                    <div class="text-xs text-base-content/70">今月の新規顧客数</div>
                                </div>
                                <div>
                                <div class="text-2xl font-bold">33%</div>
                                <div class="text-xs text-base-content/70">今月のリピート率</div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="openEditProviderModal('トレーニング機器A', 'equipment')">
                                <i class="fas fa-edit mr-1"></i>
                                編集する
                            </button>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
                            <div class="flex items-center gap-4">
                                <div class="avatar">
                                    <div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center">
                                        <i class="fas fa-user text-lg text-white flex w-full h-full items-center justify-center"></i>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold">田中 太郎</h3>
                                </div>
                            </div>
                            <div class="flex items-center gap-8 text-center">
                                <div>
                                    <div class="text-2xl font-bold">419</div>
                                    <div class="text-xs text-base-content/70">登録顧客数</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold">82</div>
                                    <div class="text-xs text-base-content/70">今月のカルテ数</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold">15</div>
                                    <div class="text-xs text-base-content/70">今月の新規顧客数</div>
                                </div>
                                <div>
                                <div class="text-2xl font-bold">14%</div>
                                <div class="text-xs text-base-content/70">今月のリピート率</div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="openEditProviderModal('田中 太郎', 'staff')">
                                <i class="fas fa-edit mr-1"></i>
                                編集する
                            </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- スポンサー -->
            <!-- <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title mb-4">スポンサー</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div class="aspect-video bg-base-200 rounded-lg flex items-center justify-center">
                            <img src="https://via.placeholder.com/200x100?text=Sponsor1" alt="スポンサー1" class="max-w-full max-h-full object-contain" />
                        </div>
                        <div class="aspect-video bg-base-200 rounded-lg flex items-center justify-center">
                            <img src="https://via.placeholder.com/200x100?text=Sponsor2" alt="スポンサー2" class="max-w-full max-h-full object-contain" />
                        </div>
                        <div class="aspect-video bg-base-200 rounded-lg flex items-center justify-center">
                            <img src="https://via.placeholder.com/200x100?text=Sponsor3" alt="スポンサー3" class="max-w-full max-h-full object-contain" />
                        </div>
                        <div class="aspect-video bg-base-200 rounded-lg flex items-center justify-center">
                            <img src="https://via.placeholder.com/200x100?text=Sponsor4" alt="スポンサー4" class="max-w-full max-h-full object-contain" />
                        </div>
                        <div class="aspect-video bg-base-200 rounded-lg flex items-center justify-center">
                            <img src="https://via.placeholder.com/200x100?text=Sponsor5" alt="スポンサー5" class="max-w-full max-h-full object-contain" />
                        </div>
                    </div>
                </div> -->
            </div>
            </div>
            </div>


                <!-- 問診票一覧コンテンツ -->
                <div id="questionnairesContent" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h1 class="text-2xl font-bold">問診票一覧</h1>
                        <div class="flex items-center gap-2">
                            <button class="btn btn-primary btn-sm" onclick="showQuestionnaireBuilder()">
                                <i class="fas fa-plus mr-1"></i>新規問診票を作成
                            </button>
                            <button class="btn btn-ghost btn-sm">
                                <i class="fas fa-cog mr-1"></i>設定
                            </button>
                        </div>
                    </div>

                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title">問診票 一覧</h2>
                            <div class="overflow-x-auto">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th class="w-16">NO</th>
                                            <th>問診票名</th>
                                            <th>URL</th>
                                            <th class="w-40">QRコード</th>
                                            <th class="w-28"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="questionnaireTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 問診票詳細（ページ内表示） -->
                <div id="questionnaireDetailContent" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <button class="btn btn-ghost btn-sm" onclick="backToQuestionnaires()">
                                <i class="fas fa-arrow-left mr-1"></i> 戻る
                            </button>
                            <h1 class="text-2xl font-bold"><span id="qdTitle">問診票詳細</span></h1>
                        </div>
                    </div>

                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <!-- 基本情報 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="space-y-3">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">名前</span></label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input id="qd_lastName" class="input input-bordered" placeholder="姓" />
                                            <input id="qd_firstName" class="input input-bordered" placeholder="名" />
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">名前(ふりがな)</span></label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input id="qd_kanaLast" class="input input-bordered" placeholder="かな姓" />
                                            <input id="qd_kanaFirst" class="input input-bordered" placeholder="かな名" />
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">性別</span></label>
                                        <div class="flex items-center gap-4">
                                            <label class="label cursor-pointer"><input type="radio" name="qd_gender" value="male" class="radio" /><span class="ml-2">男性</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_gender" value="female" class="radio" /><span class="ml-2">女性</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_gender" value="noanswer" class="radio" /><span class="ml-2">回答しない</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_gender" value="other" class="radio" /><span class="ml-2">その他</span></label>
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">メールアドレス</span></label>
                                        <input id="qd_email" class="input input-bordered" placeholder="mail@example.com" />
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">携帯電話番号</span></label>
                                        <input id="qd_phone" class="input input-bordered" placeholder="012-3456-7890" />
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">生年月日</span></label>
                                        <div class="grid grid-cols-3 gap-2">
                                            <select id="qd_birthY" class="select select-bordered"></select>
                                            <select id="qd_birthM" class="select select-bordered"></select>
                                            <select id="qd_birthD" class="select select-bordered"></select>
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">郵便番号（ハイフンなし）</span></label>
                                        <div class="flex gap-2">
                                            <input id="qd_zip" class="input input-bordered flex-1" placeholder="1050001" />
                                            <button class="btn btn-outline" onclick="event.preventDefault(); alert('住所検索はダミーです');">住所検索</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 症状関連 -->
                                <div class="space-y-4">
                                    <div class="form-control">
                                        <label class="label mb-2"><span class="label-text">現在の症状を選択してください（複数選択可）</span></label>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <label class="flex items-center"><input type="checkbox" name="qd_severity" value="sukoshi" class="checkbox mr-2" />スキマに痛い</label>
                                            <label class="flex items-center"><input type="checkbox" name="qd_severity" value="ugokasu" class="checkbox mr-2" />動かすと痛い</label>
                                            <label class="flex items-center"><input type="checkbox" name="qd_severity" value="sawaru" class="checkbox mr-2" />触ると痛い</label>
                                            <label class="flex items-center"><input type="checkbox" name="qd_severity" value="nemurenai" class="checkbox mr-2" />眠れない</label>
                                            <label class="flex items-center"><input type="checkbox" name="qd_severity" value="omodarui" class="checkbox mr-2" />重だるい</label>
                                            <label class="flex items-center"><input type="checkbox" name="qd_severity" value="sonota" class="checkbox mr-2" />その他</label>
                                        </div>
                                    </div>

                                    <div class="form-control">
                                        <label class="label"><span class="label-text">症状の出ている箇所をタッチしてください</span></label>
                                        <div id="qdBodyMapInline" class="symptoms-input mt-3">
                                            <div>
                                                <div class="data body-position">
                                                    <div class="img-center" id="qdClickableArea" style="width:345px;height:345px;position:relative;">
                                                        <img class="clickable" style="position:absolute;" src="https://carecle.com/assets/questionnaires/position1-bcc9bb91059d22df934293e7b6cbe0312f243195dfa1a66d50ddf6abd7761a2e.png" alt="Position1">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-base-content/60 mt-1">クリックで追加、もう一度クリックで削除できます</div>
                                    </div>
                                    
                                    <!-- 痛みの強さ 1-10 スケール -->
                                    <div class="form-control mt-4">
                                        <label class="label"><span class="label-text">痛みの強さを選択して下さい。（1が痛みなし、10が痛みがとても強い）</span></label>
                                        <div class="flex flex-wrap pain-scale">
                                            <div class="join">
                                                <button class="btn join-item" type="button" onclick="setPainLevel(1)">1</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(2)">2</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(3)">3</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(4)">4</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(5)">5</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(6)">6</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(7)">7</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(8)">8</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(9)">9</button>
                                                <button class="btn join-item" type="button" onclick="setPainLevel(10)">10</button>
                                            </div>
                                        </div>
                                        <input type="hidden" id="qd_pain" value="" />
                                    </div>
                                </div>
                            </div>

                            <div class="divider"></div>

                            <!-- 追加設問群 -->
                            <div class="space-y-6">
                                <div class="form-control">
                                    <label class="label"><span class="label-text">症状が出始めた時期を選択してください</span></label>
                                    <div class="flex flex-wrap gap-3 text-sm">
                                        <label class="label cursor-pointer"><input type="radio" name="qd_onset" value="3d" class="radio" /><span class="ml-2">3日以内</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_onset" value="1m" class="radio" /><span class="ml-2">1ヶ月以内</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_onset" value="3m" class="radio" /><span class="ml-2">3ヶ月以内</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_onset" value="over3m" class="radio" /><span class="ml-2">3ヶ月以上前から</span></label>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">症状が始めたきっかけを選択してください</span></label>
                                    <div class="flex flex-wrap gap-3 text-sm mb-2">
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="butuketa" class="radio" /><span class="ml-2">ぶつけた</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="neta" class="radio" /><span class="ml-2">寝ぼけた</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="hineri" class="radio" /><span class="ml-2">捻った</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="mota" class="radio" /><span class="ml-2">荷を持った</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="oshita" class="radio" /><span class="ml-2">挟んだ</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="tennda" class="radio" /><span class="ml-2">転んだ</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="wakaranai" class="radio" /><span class="ml-2">わからない</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_trigger" value="other" class="radio" /><span class="ml-2">その他（記入）</span></label>
                                    </div>
                                    <textarea id="qd_trigger_note" class="textarea textarea-bordered" placeholder="具体的な内容をご記入ください"></textarea>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">現在、他の医療機関に通院していますか？</span></label>
                                    <div class="flex gap-4 text-sm">
                                        <label class="label cursor-pointer"><input type="radio" name="qd_hospital" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_hospital" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">今までに骨折・手術などの病気やケガをされたことがありますか？</span></label>
                                    <div class="flex gap-4 text-sm mb-2">
                                        <label class="label cursor-pointer"><input type="radio" name="qd_history" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_history" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                    </div>
                                    <textarea id="qd_history_note" class="textarea textarea-bordered" placeholder="具体的な内容をご記入ください"></textarea>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">今までに接骨院、整骨院、鍼灸院等に通院されたことがありますか？</span></label>
                                        <div class="flex gap-4 text-sm">
                                            <label class="label cursor-pointer"><input type="radio" name="qd_pastclinic" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_pastclinic" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">血圧は正常ですか？</span></label>
                                        <div class="flex gap-4 text-sm">
                                            <label class="label cursor-pointer"><input type="radio" name="qd_bp" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_bp" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">身体にペースメーカーや金属類がついていますか？</span></label>
                                        <div class="flex gap-4 text-sm">
                                            <label class="label cursor-pointer"><input type="radio" name="qd_pacemaker" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_pacemaker" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">低周波療法は苦手ですか？</span></label>
                                        <div class="flex gap-4 text-sm">
                                            <label class="label cursor-pointer"><input type="radio" name="qd_lowfreq" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                            <label class="label cursor-pointer"><input type="radio" name="qd_lowfreq" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">アレルギー・疾患等はありますか？</span></label>
                                    <div class="flex gap-4 text-sm mb-2">
                                        <label class="label cursor-pointer"><input type="radio" name="qd_allergy" value="yes" class="radio" /><span class="ml-2">はい</span></label>
                                        <label class="label cursor-pointer"><input type="radio" name="qd_allergy" value="no" class="radio" /><span class="ml-2">いいえ</span></label>
                                    </div>
                                    <textarea id="qd_allergy_note" class="textarea textarea-bordered" placeholder="施術者に伝えたいことがある場合はご記入ください"></textarea>
                                </div>
                            </div>

                            <div class="card-actions justify-end mt-6">
                                <button class="btn btn-primary" onclick="saveQuestionnaireFormAndPoints()">
                                    確認ページへ進む
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 問診票ビルダー（ノーコード編集） -->
                <div id="questionnaireBuilderContent" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <button class="btn btn-ghost btn-sm" onclick="backToQuestionnaires()">
                                <i class="fas fa-arrow-left mr-1"></i> 戻る
                            </button>
                            <h1 class="text-2xl font-bold">問診票ビルダー</h1>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- 左：要素ライブラリ -->
                        <div class="card bg-base-100 shadow-sm">
                            <div class="card-body p-4">
                                <h3 class="font-semibold mb-2">項目を追加</h3>
                                <div class="space-y-2 text-sm">
                                    <button class="btn btn-sm w-full" onclick="addField('text')"><i class="fas fa-font mr-1"></i>短文テキスト</button>
                                    <button class="btn btn-sm w-full" onclick="addField('textarea')"><i class="fas fa-align-left mr-1"></i>長文テキスト</button>
                                    <button class="btn btn-sm w-full" onclick="addField('radio')"><i class="fas fa-dot-circle mr-1"></i>単一選択</button>
                                    <button class="btn btn-sm w-full" onclick="addField('checkbox')"><i class="fas fa-check-square mr-1"></i>複数選択</button>
                                    <button class="btn btn-sm w-full" onclick="addField('select')"><i class="fas fa-caret-square-down mr-1"></i>プルダウン</button>
                                    <button class="btn btn-sm w-full" onclick="addField('pain')"><i class="fas fa-thermometer-half mr-1"></i>痛みスケール(1-10)</button>
                                    <button class="btn btn-sm w-full" onclick="addField('bodymap')"><i class="fas fa-user mr-1"></i>人体クリック</button>
                                    <button class="btn btn-sm w-full" onclick="addField('date')"><i class="fas fa-calendar-day mr-1"></i>日付</button>
                                    <button class="btn btn-sm w-full" onclick="addField('phone')"><i class="fas fa-phone mr-1"></i>電話番号</button>
                                </div>
                            </div>
                        </div>

                        <!-- 中央：プレビュー -->
                        <div class="card bg-base-100 shadow-sm lg:col-span-2">
                            <div class="card-body p-4">
                                <h3 class="font-semibold mb-2">プレビュー</h3>
                                <div id="builderPreview" class="space-y-3"></div>
                                <div class="divider"></div>
                                <div class="flex justify-end gap-2">
                                    <button class="btn" onclick="saveBuilderDraft()"><i class="fas fa-save mr-1"></i>下書き保存</button>
                                    <button class="btn btn-primary" onclick="publishQuestionnaire()"><i class="fas fa-cloud-upload-alt mr-1"></i>公開</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- メニュー管理コンテンツ -->
                <div id="menuManagementContent" class="hidden">
                    <!-- 検索＋設定 -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="join">
                            <input id="menuSearchInput" type="text" class="input input-bordered join-item w-72" placeholder="サービス名" />
                            <button class="btn btn-primary join-item" onclick="searchMenus()"><i class="fas fa-search mr-1"></i>検索する</button>
                        </div>
                        <button class="btn btn-ghost"><i class="fas fa-cog mr-1"></i>設定</button>
                    </div>

                    <!-- タブ -->
                    <div class="flex items-center justify-between mb-3">
                        <div role="tablist" class="tabs tabs-boxed">
                            <a role="tab" id="tabMenu" class="tab tab-active" onclick="switchMenuTab('menu')">メニュー一覧</a>
                            <a role="tab" id="tabOption" class="tab" onclick="switchMenuTab('option')">オプションメニュー一覧</a>
                            <a role="tab" id="tabGoods" class="tab" onclick="switchMenuTab('goods')">物販メニュー一覧</a>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="createNewMenu()"><i class="fas fa-plus mr-1"></i>新規作成</button>
                    </div>

                    <!-- メニュー一覧タブ -->
                    <div id="menuListSection">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body p-4">
                                <div class="overflow-x-auto">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="w-16">並び替え</th>
                                                <th>サービス名</th>
                                                <th class="w-24">提供時間</th>
                                                <th class="w-28">料金（税込）</th>
                                                <th class="w-20">税率（%）</th>
                                                <th class="w-64"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="menuListTableBody">
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>夏までの大チャンス【先着30名様】話題の「ビジリス」初回30分お試し1コイン500円！7月末まで日限定！事前にスタイルUPしませんか！？</td>
                                                <td>30分</td>
                                                <td>￥500</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs"><span>予約先選択</span><i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs" onclick="openMenuEdit()">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>【6,300円】早割　整体60分　店舗予約価格</td>
                                                <td>60分</td>
                                                <td>￥6,300</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs" onclick="openMenuEdit()">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>【8,400円】早割　整体80分　店舗予約価格</td>
                                                <td>80分</td>
                                                <td>￥8,400</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs" onclick="openMenuEdit()">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>【10,500円】早割　整体100分　店舗予約価格</td>
                                                <td>100分</td>
                                                <td>￥10,500</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs" onclick="openMenuEdit()">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>【8,400円】早割　整体＋美容整体60分　店舗予約価格</td>
                                                <td>60分</td>
                                                <td>￥8,400</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs" onclick="openMenuEdit()">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>【8,400円】早割　整体＋ボディ60分　店舗予約価格</td>
                                                <td>60分</td>
                                                <td>￥8,400</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs" onclick="openMenuEdit()">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- オプションメニュー一覧タブ -->
                    <div id="optionListSection" class="hidden">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body p-4">
                                <div class="overflow-x-auto">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="w-16">並び替え</th>
                                                <th>オプション名</th>
                                                <th class="w-24">提供時間</th>
                                                <th class="w-28">料金（税込）</th>
                                                <th class="w-20">税率（%）</th>
                                                <th class="w-64"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>ヘッドマッサージ</td>
                                                <td>15分</td>
                                                <td>￥1,500</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>フットケア</td>
                                                <td>20分</td>
                                                <td>￥1,800</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 物販メニュー一覧タブ -->
                    <div id="goodsListSection" class="hidden">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body p-4">
                                <div class="overflow-x-auto">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="w-16">並び替え</th>
                                                <th>商品名</th>
                                                <th class="w-24">提供時間</th>
                                                <th class="w-28">料金（税込）</th>
                                                <th class="w-20">税率（%）</th>
                                                <th class="w-64"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><i class="fas fa-grip-vertical text-base-content/60"></i></td>
                                                <td>温感ジェル</td>
                                                <td>-</td>
                                                <td>￥2,200</td>
                                                <td>10</td>
                                                <td class="space-x-2">
                                                    <button class="btn btn-info btn-xs">予約先選択<i class="fas fa-caret-down ml-1"></i></button>
                                                    <button class="btn btn-success btn-xs">編集する</button>
                                                    <button class="btn btn-error btn-xs">削除する</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- メニュー編集コンテンツ -->
                <div id="menuEditContent" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <button class="btn btn-ghost btn-sm" onclick="backToMenuList()"><i class="fas fa-arrow-left mr-1"></i> 戻る</button>
                            <h1 class="text-2xl font-bold">編集・メニュー管理</h1>
                        </div>
                    </div>

                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body p-6">
                            <div class="grid grid-cols-1 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text">担当者</span></label>
                                    <select class="select select-bordered">
                                        <option>岩崎</option>
                                        <option>田中 太郎</option>
                                        <option>山田 花子</option>
                                    </select>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">サービス名</span><span class="text-error ml-1">*</span></label>
                                    <input id="me_service" class="input input-bordered" value="【6,300円】早割　整体６０分　店舗予約価格" />
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">メニュータイプ</span></label>
                                    <select class="select select-bordered">
                                        <option>自費</option>
                                        <option>保険</option>
                                    </select>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">写真</span></label>
                                    <button class="btn btn-outline w-40">ファイルを選択する</button>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">メニュー説明</span></label>
                                    <textarea class="textarea textarea-bordered h-32">整体６０分コース　早割３００円オフ</textarea>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">提供時間</span></label>
                                    <input id="me_minutes" class="input input-bordered" value="60" />
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">インターバル(分)</span></label>
                                    <input id="me_interval" class="input input-bordered" value="60" />
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">提供価格</span></label>
                                    <input id="me_price" class="input input-bordered" value="6300" oninput="updateTaxIncluded()" />
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">提供価格（税込）</span></label>
                                    <input id="me_price_inc" class="input input-bordered" value="6,300円" disabled />
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">税区分</span></label>
                                        <select id="me_tax_kind" class="select select-bordered" onchange="updateTaxIncluded()">
                                            <option value="inside">内税</option>
                                            <option value="outside">外税</option>
                                        </select>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">税率</span></label>
                                        <select id="me_tax_rate" class="select select-bordered" onchange="updateTaxIncluded()">
                                            <option value="10">10%</option>
                                            <option value="8">8%</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">同時予約数</span></label>
                                    <input class="input input-bordered" value="1" />
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">部屋の紐付け</span></label>
                                    <select class="select select-bordered">
                                        <option>予約枠</option>
                                    </select>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">問診票の紐付け</span></label>
                                    <select id="me_questionnaire" class="select select-bordered">
                                        <option value="">選択してください</option>
                                    </select>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">選択種別</span></label>
                                    <div class="flex items-center gap-6">
                                        <label class="label cursor-pointer"><input type="checkbox" class="checkbox" /> <span class="ml-2">初回のみ</span></label>
                                        <label class="label cursor-pointer"><input type="checkbox" class="checkbox" /> <span class="ml-2">2回目以降</span></label>
                                    </div>
                                </div>

                                <div class="form-control">
                                    <label class="label"><span class="label-text">web予約ページに表示する</span></label>
                                    <input type="checkbox" class="toggle" />
                                </div>

                                <div class="card-actions justify-center mt-4">
                                    <button class="btn btn-primary">更新申請</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- スケジュール管理コンテンツ -->
                <div id="scheduleContent" class="hidden">
                    <!-- ヘッダー -->
                    <div class="mb-6">
                        <h1 class="text-2xl font-bold mb-4">スケジュール管理</h1>
                        
                        <!-- 上部パネル -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                            <!-- 左パネル：日付選択と予約ページ -->
                            <div class="card bg-base-100 shadow-sm">
                                <div class="card-body p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <button class="btn btn-info btn-sm" onclick="goToToday()">今日</button>
                                        <input type="date" class="input input-bordered input-sm" id="datePicker" onchange="changeSelectedDate()" />
                                    </div>
                                    <!-- 週表示用の日付範囲選択 -->
                                    <div id="weekRangePicker" class="hidden">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-sm">週:</span>
                                            <input type="date" class="input input-bordered input-sm" id="weekStartDate" onchange="changeWeekRange()" />
                                            <span class="text-sm">〜</span>
                                            <input type="date" class="input input-bordered input-sm" id="weekEndDate" onchange="changeWeekRange()" />
                                        </div>
                                    </div>
                                    <div class="text-sm">
                                        <a href="#" class="link link-primary">予約ページを表示する</a>
                                    </div>
                                    <div class="form-control mt-2">
                                        <label class="label cursor-pointer justify-start gap-2">
                                            <input type="checkbox" class="toggle toggle-success" checked />
                                            <span class="label-text text-sm">公開中</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右パネル：デイリーメモ -->
                            <div class="card bg-base-100 shadow-sm">
                                <div class="card-body p-4">
                                    <h3 class="font-semibold mb-2">デイリーメモ</h3>
                                    <textarea class="textarea textarea-bordered w-full h-20" placeholder="メモを保存・表示できます"></textarea>
                                    <div class="card-actions justify-end mt-2">
                                        <button class="btn btn-info btn-sm">
                                            <i class="fas fa-save mr-1"></i>
                                            保存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- カレンダー表示形式選択 -->
                        <div class="flex items-center gap-4 mb-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text text-sm">表示形式</span>
                                </label>
                                <div class="join">
                                    <input class="join-item btn btn-sm" type="radio" name="calendarView" aria-label="日" value="day" checked onchange="changeCalendarView()" />
                                    <input class="join-item btn btn-sm" type="radio" name="calendarView" aria-label="週" value="week" onchange="changeCalendarView()" />
                                    <input class="join-item btn btn-sm" type="radio" name="calendarView" aria-label="月" value="month" onchange="changeCalendarView()" />
                                </div>
                            </div>
                        </div>
                        
                        <!-- 下部パネル -->
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text text-sm">スタッフで絞り込む</span>
                                </label>
                                <select class="select select-bordered select-sm w-full max-w-xs" id="staffFilter" onchange="updateScheduleView()">
                                    <option value="">すべて</option>
                                    <option value="tanaka">田中 太郎</option>
                                    <option value="yamada">山田 花子</option>
                                    <option value="sato">佐藤 次郎</option>
                                    <option value="suzuki">鈴木 美咲</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text text-sm">担当者色分け</span>
                                </label>
                                <div class="flex gap-2 flex-wrap">
                                    <div class="flex items-center gap-1">
                                        <div class="w-3 h-3 bg-green-500 rounded"></div>
                                        <span class="text-xs">田中</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                        <span class="text-xs">山田</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="w-3 h-3 bg-purple-500 rounded"></div>
                                        <span class="text-xs">佐藤</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="w-3 h-3 bg-yellow-500 rounded"></div>
                                        <span class="text-xs">鈴木</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <div class="w-3 h-3 bg-gray-500 rounded"></div>
                                        <span class="text-xs">機器</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ml-auto flex gap-2">
                                <button class="btn btn-outline btn-sm">
                                    <i class="fas fa-cog mr-1"></i>
                                    設定
                                </button>
                                <button class="btn btn-info btn-sm" onclick="openNewCustomerModal()">
                                    <i class="fas fa-plus mr-1"></i>
                                    +部屋名登録
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- スケジュール表示形式選択 -->
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-sm">スケジュール表示</span>
                            </label>
                            <div class="join">
                                <input class="join-item btn btn-sm" type="radio" name="view" aria-label="すべて" value="all" checked onchange="updateScheduleView()" />
                                <input class="join-item btn btn-sm" type="radio" name="view" aria-label="部屋のみ" value="room" onchange="updateScheduleView()" />
                                <input class="join-item btn btn-sm" type="radio" name="view" aria-label="スタッフのみ" value="staff" onchange="updateScheduleView()" />
                            </div>
                        </div>
                        <!-- 現在表示の日付 -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text text-sm">現在表示</span>
                            </label>
                            <div class="badge badge-info" id="currentDateBadge">
                                <i class="fas fa-calendar mr-1"></i>
                                <span id="currentDateText">2025年7月16日 (水)</span>
                            </div>
                        </div>
                        
                        <!-- 週表示用の日付範囲 -->
                        <div class="form-control" id="weekDateRange" style="display: none;">
                            <label class="label">
                                <span class="label-text text-sm">表示期間</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <button class="btn btn-sm btn-outline" onclick="navigateWeek(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="badge badge-primary" id="weekDateRangeBadge">
                                    <i class="fas fa-calendar-week mr-1"></i>
                                    <span id="weekDateRangeText">2025年7月13日(日) - 19日(土)</span>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="navigateWeek(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- スケジュールテーブル -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body p-0">
                            <div class="overflow-x-auto">
                                <table class="table table-pin-rows schedule-table">
                                    <thead id="scheduleTableHead">
                                        <tr class="bg-base-200">
                                            <th class="w-20 text-center">時間</th>
                                            <th class="text-center">部屋</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 予約詳細ツールチップ -->
                    <div id="reservationTooltip" class="fixed z-50 bg-white border border-gray-300 rounded-lg shadow-lg p-4 hidden max-w-sm">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold text-lg" id="tooltipPatientName">患者名</h4>
                            <button class="btn btn-primary btn-xs" onclick="editReservationFromTooltip()">
                                <i class="fas fa-edit mr-1"></i>
                                編集
                            </button>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div><strong>時間:</strong> <span id="tooltipTime">--:--</span></div>
                            <div><strong>メニュー:</strong> <span id="tooltipMenu">--</span></div>
                            <div><strong>年齢・性別:</strong> <span id="tooltipAge">--</span></div>
                            <div><strong>初診・再診:</strong> <span id="tooltipVisitType">--</span></div>
                            <div><strong>電話番号:</strong> <span id="tooltipPhone">--</span></div>
                            <div><strong>備考:</strong> <span id="tooltipNotes">--</span></div>
                        </div>
                    </div>

                    <!-- 右サイドバー（デイリーメモ） -->
                    <div class="fixed right-4 top-1/2 transform -translate-y-1/2 w-80 hidden" id="dailyMemoSidebar">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="card-title text-lg">
                                        <i class="fas fa-sticky-note text-info mr-2"></i>
                                        デイリーメモ
                                    </h3>
                                    <button class="btn btn-ghost btn-sm" onclick="closeDailyMemo()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">メモを保存</span>
                                    </label>
                                    <textarea class="textarea textarea-bordered h-32" placeholder="メモを入力してください"></textarea>
                                </div>
                                <div class="card-actions justify-end mt-4">
                                    <button class="btn btn-primary btn-sm">
                                        <i class="fas fa-save mr-1"></i>
                                        保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <!-- 新規登録モーダル -->
    <dialog id="newProviderModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-plus mr-2 text-info"></i>
                新規サービス提供者登録
            </h3>
            
            <div class="space-y-4">
                <!-- タイプ選択 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">タイプ</span>
                    </label>
                    <select class="select select-bordered w-full" id="providerType">
                        <option value="">選択してください</option>
                        <option value="staff">スタッフ</option>
                        <option value="equipment">機器・設備</option>
                    </select>
                </div>

                <!-- 名前 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">名前</span>
                    </label>
                    <input type="text" placeholder="名前を入力してください" class="input input-bordered w-full" id="providerName" />
                </div>

                <!-- 説明 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">説明</span>
                    </label>
                    <textarea class="textarea textarea-bordered" placeholder="説明を入力してください" id="providerDescription"></textarea>
                </div>

                <!-- 初期設定 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">初期登録顧客数</span>
                        </label>
                        <input type="number" placeholder="0" class="input input-bordered w-full" id="initialCustomers" value="0" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">目標リピート率（%）</span>
                        </label>
                        <input type="number" placeholder="50" class="input input-bordered w-full" id="targetRepeatRate" value="50" />
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-ghost">キャンセル</button>
                    <button class="btn btn-primary" onclick="saveNewProvider()">
                        <i class="fas fa-save mr-1"></i>
                        登録する
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- 問診票詳細モーダル（人体クリックマップ） -->
    <dialog id="questionnaireDetailModal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-file-medical mr-2 text-primary"></i>
                <span id="qdTitle">問診票詳細</span>
            </h3>

            <div class="form-group" id="qdContainer">
                <label class="form-label">症状の出ている箇所をタッチしてください</label>
                <div id="qdBodyMap" class="symptoms-input mt-3">
                    <div>
                        <div class="data body-position">
                            <div class="img-center" id="qdClickableArea" style="width:345px;height:345px;position:relative;">
                                <img class="clickable" style="position:absolute;" src="https://carecle.com/assets/questionnaires/position1-bcc9bb91059d22df934293e7b6cbe0312f243195dfa1a66d50ddf6abd7761a2e.png" alt="Position1">
                                <!-- 以下: ユーザー提供の入力群をそのまま埋め込み -->
                                <input type="checkbox" name="body_positions[][]" id="front-atama-" value="前頭部">
                                <label for="front-atama-" class="pos pos1" style="top:0;left:68px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="back-atama-" value="後頭部">
                                <label for="back-atama-" class="pos pos1" style="top:0;left:253px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="nodo-" value="喉">
                                <label for="nodo-" class="pos pos1" style="top:43px;left:67px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-kata-" value="前右肩">
                                <label for="right-front-kata-" class="pos pos1" style="top:53px;left:93px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-kata-" value="前左肩">
                                <label for="left-front-kata-" class="pos pos1" style="top:53px;left:40px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-mune-" value="前左胸">
                                <label for="left-front-mune-" class="pos pos1" style="top:77px;left:53px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-mune-" value="前右胸">
                                <label for="right-front-mune-" class="pos pos1" style="top:77px;left:83px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-jouwan-" value="前左上腕">
                                <label for="left-front-jouwan-" class="pos pos1" style="top:90px;left:26px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-jouwan-" value="前右上腕">
                                <label for="right-front-jouwan-" class="pos pos1" style="top:90px;left:108px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-zenwan-" value="前左前腕">
                                <label for="left-front-zenwan-" class="pos pos1" style="top:117px;left:20px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-zenwan-" value="前右前腕">
                                <label for="right-front-zenwan-" class="pos pos1" style="top:117px;left:117px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-tekubi-" value="前左手首">
                                <label for="left-front-tekubi-" class="pos pos1" style="top:143px;left:10px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-tekubi-" value="前右手首">
                                <label for="right-front-tekubi-" class="pos pos1" style="top:143px;left:125px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-yubi-" value="前左手指">
                                <label for="left-front-yubi-" class="pos pos1" style="top:167px;left:0px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-yubi-" value="前右手指">
                                <label for="right-front-yubi-" class="pos pos1" style="top:167px;left:136px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-zinbu-" value="前左腎部">
                                <label for="left-front-zinbu-" class="pos pos1" style="top:121px;left:54px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-zinbu-" value="前右腎部">
                                <label for="right-front-zinbu-" class="pos pos1" style="top:121px;left:82px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-sokeibu-" value="前左鼠蹊部">
                                <label for="left-front-sokeibu-" class="pos pos1" style="top:160px;left:54px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-sokeibu-" value="前右鼠蹊部">
                                <label for="right-front-sokeibu-" class="pos pos1" style="top:160px;left:82px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-hutomomo-" value="前左太もも">
                                <label for="left-front-hutomomo-" class="pos pos1" style="top:199px;left:49px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-hutomomo-" value="前右太もも">
                                <label for="right-front-hutomomo-" class="pos pos1" style="top:199px;left:87px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-hiza-" value="前左膝">
                                <label for="left-front-hiza-" class="pos pos1" style="top:233px;left:46px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-hiza-" value="前右膝">
                                <label for="right-front-hiza-" class="pos pos1" style="top:233px;left:90px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-zenkei-" value="前左前脛">
                                <label for="left-front-zenkei-" class="pos pos1" style="top:270px;left:46px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-zenkei-" value="前右前脛">
                                <label for="right-front-zenkei-" class="pos pos1" style="top:270px;left:90px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-front-asi-" value="前左足">
                                <label for="left-front-asi-" class="pos pos1" style="top:302px;left:46px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-front-asi-" value="前右足">
                                <label for="right-front-asi-" class="pos pos1" style="top:302px;left:92px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="kubi-" value="首">
                                <label for="kubi-" class="pos pos1" style="top:43px;left:252px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-kata-" value="後右肩">
                                <label for="right-back-kata-" class="pos pos1" style="top:53px;left:278px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-kata-" value="後左肩">
                                <label for="left-back-kata-" class="pos pos1" style="top:53px;left:225px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-jouwan-" value="後左上腕">
                                <label for="left-back-jouwan-" class="pos pos1" style="top:90px;left:211px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-jouwan-" value="後右上腕">
                                <label for="right-back-jouwan-" class="pos pos1" style="top:90px;left:293px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-zenwan-" value="後左前腕">
                                <label for="left-back-zenwan-" class="pos pos1" style="top:117px;left:205px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-zenwan-" value="後右前腕">
                                <label for="right-back-zenwan-" class="pos pos1" style="top:117px;left:302px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-tekubi-" value="後左手首">
                                <label for="left-back-tekubi-" class="pos pos1" style="top:143px;left:195px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-tekubi-" value="後右手首">
                                <label for="right-back-tekubi-" class="pos pos1" style="top:143px;left:310px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-yubi-" value="後左手指">
                                <label for="left-back-yubi-" class="pos pos1" style="top:167px;left:185px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-yubi-" value="後右手指">
                                <label for="right-back-yubi-" class="pos pos1" style="top:167px;left:321px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-senaka-" value="後左背中上">
                                <label for="left-back-senaka-" class="pos pos1" style="top:76px;left:240px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-senaka-" value="後右背中上">
                                <label for="right-back-senaka-" class="pos pos1" style="top:76px;left:266px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-senaka2-" value="後左背中下">
                                <label for="left-back-senaka2-" class="pos pos1" style="top:103px;left:239px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-senaka2-" value="後右背中下">
                                <label for="right-back-senaka2-" class="pos pos1" style="top:103px;left:267px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-kosi-" value="後左腰">
                                <label for="left-back-kosi-" class="pos pos1" style="top:130px;left:240px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-kosi-" value="後右腰">
                                <label for="right-back-kosi-" class="pos pos1" style="top:130px;left:267px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-siri-" value="後左尻">
                                <label for="left-back-siri-" class="pos pos1" style="top:160px;left:239px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-siri-" value="後右尻">
                                <label for="right-back-siri-" class="pos pos1" style="top:160px;left:267px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-hutomomo-" value="後左太もも">
                                <label for="left-back-hutomomo-" class="pos pos1" style="top:199px;left:234px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-hutomomo-" value="後右太もも">
                                <label for="right-back-hutomomo-" class="pos pos1" style="top:199px;left:272px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-hiza-" value="後左膝">
                                <label for="left-back-hiza-" class="pos pos1" style="top:233px;left:231px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-hiza-" value="後右膝">
                                <label for="right-back-hiza-" class="pos pos1" style="top:233px;left:275px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-hukurahagi-" value="後左ふくらはぎ">
                                <label for="left-back-hukurahagi-" class="pos pos1" style="top:270px;left:231px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-hukurahagi-" value="後右ふくらはぎ">
                                <label for="right-back-hukurahagi-" class="pos pos1" style="top:270px;left:275px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="left-back-akiresu-" value="後左アキレス腱">
                                <label for="left-back-akiresu-" class="pos pos1" style="top:302px;left:231px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="right-back-akiresu-" value="後右アキレス腱">
                                <label for="right-back-akiresu-" class="pos pos1" style="top:302px;left:277px;"></label>
                                <input type="checkbox" name="body_positions[][]" id="shinkabu-" value="心窩部">
                                <label for="shinkabu-" class="pos pos1" style="top: 99px;left: 68px;"></label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <div class="flex gap-2">
                    <button class="btn btn-ghost" onclick="closeQuestionnaireDetail()">閉じる</button>
                    <button class="btn btn-primary" onclick="saveBodyPositions()">
                        <i class="fas fa-save mr-1"></i>
                        選択を保存
                    </button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- 新規問診票モーダル（簡易） -->
    <dialog id="newQuestionnaireModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4"><i class="fas fa-file-alt mr-2 text-primary"></i>新規問診票</h3>
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span class="label-text font-semibold">問診票名</span></label>
                    <input id="qnName" class="input input-bordered" placeholder="例: 痛み・しびれのケア" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text font-semibold">用途</span></label>
                    <input id="qnPurpose" class="input input-bordered" placeholder="例: numbness_care" />
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost">キャンセル</button>
                <button class="btn btn-primary" onclick="saveNewQuestionnaire()"><i class="fas fa-save mr-1"></i>保存</button>
            </div>
        </div>
    </dialog>

    <!-- 新規予約登録モーダル -->
    <dialog id="newReservationModal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-plus mr-2 text-primary"></i>
                新規予約登録
            </h3>
            
            <!-- 予約日時（左上に配置） -->
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text font-semibold">予約日時 <span class="text-error">*</span></span>
                </label>
                <div class="flex gap-2">
                    <input type="date" class="input input-bordered w-40" id="reservationDate" />
                    <input type="time" class="input input-bordered w-28" id="reservationTime" />
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 基本情報 -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-base border-b pb-2">基本情報</h4>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">お客様名 <span class="text-error">*</span></span>
                        </label>
                        <input type="text" placeholder="お客様名を入力" class="input input-bordered w-full" id="customerName" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">電話番号</span>
                        </label>
                        <input type="tel" placeholder="090-1234-5678" class="input input-bordered w-full" id="customerPhone" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">年齢・性別</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="number" placeholder="年齢" class="input input-bordered w-20" id="customerAge" />
                            <select class="select select-bordered flex-1" id="customerGender">
                                <option value="">性別</option>
                                <option value="male">男性</option>
                                <option value="female">女性</option>
                                <option value="other">その他</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">初診・再診</span>
                        </label>
                        <div class="flex gap-2">
                            <label class="label cursor-pointer">
                                <input type="radio" name="visitType" value="first" class="radio radio-primary" checked />
                                <span class="label-text ml-2">初診</span>
                            </label>
                            <label class="label cursor-pointer">
                                <input type="radio" name="visitType" value="return" class="radio radio-primary" />
                                <span class="label-text ml-2">再診</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 予約情報 -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-base border-b pb-2">予約情報</h4>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">施術時間</span>
                        </label>
                        <select class="select select-bordered w-full" id="treatmentDuration">
                            <option value="30">30分</option>
                            <option value="60">60分</option>
                            <option value="90">90分</option>
                            <option value="120">120分</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">担当者</span>
                        </label>
                        <select class="select select-bordered w-full" id="assignedStaff">
                            <option value="">担当者を選択</option>
                            <option value="tanaka">田中 太郎</option>
                            <option value="yamada">山田 花子</option>
                            <option value="sato">佐藤 次郎</option>
                            <option value="suzuki">鈴木 美咲</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">施術メニュー</span>
                        </label>
                        <select class="select select-bordered w-full" id="treatmentMenu">
                            <option value="">メニューを選択</option>
                            <option value="basic30">基本整体コース（30分）</option>
                            <option value="standard60">スタンダード整体コース（60分）</option>
                            <option value="premium90">プレミアム整体コース（90分）</option>
                            <option value="fullbody120">フルボディケアコース（120分）</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 備考 -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text font-semibold">備考・特記事項</span>
                </label>
                <textarea class="textarea textarea-bordered h-20" placeholder="備考があれば入力してください" id="reservationNotes"></textarea>
            </div>

            <div class="modal-action">
                <div class="flex gap-2">
                    <button class="btn btn-ghost" onclick="document.getElementById('newReservationModal').close()">キャンセル</button>
                    <button class="btn btn-primary" type="button" onclick="saveNewReservation()">
                        <i class="fas fa-save mr-1"></i>
                        予約を登録
                    </button>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        
    </script>

    <!-- カルテモーダル -->
    <dialog id="patientChartModal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-user-md mr-2 text-success"></i>
                スケジュール登録
            </h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 左側：基本情報 -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-base border-b pb-2">基本情報</h4>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">開始時間</span>
                        </label>
                        <input type="datetime-local" class="input input-bordered w-full" id="chartStartTime" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">終了時間</span>
                        </label>
                        <input type="datetime-local" class="input input-bordered w-full" id="chartEndTime" disabled />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">顧客ID/顧客名</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="text" placeholder="ID: 688" class="input input-bordered w-24" id="chartCustomerId" />
                            <input type="text" class="input input-bordered flex-1" id="chartCustomerName" placeholder="お客様名を入力" />
                            <button class="btn btn-info btn-sm">
                                詳細ページへ
                            </button>
                        </div>
                        <button class="btn btn-success btn-sm mt-2 w-full">
                            新規顧客登録
                        </button>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">部屋名</span>
                        </label>
                        <select class="select select-bordered w-full" id="chartRoom">
                            <option value="">予約枠</option>
                            <option value="room1">施術室1</option>
                            <option value="room2">施術室2</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">メニュー</span>
                        </label>
                        <select class="select select-bordered w-full" id="chartMenu">
                            <option value="">【30分】早整体 美容6.0分 店舗予約6,300円</option>
                            <option value="basic30">基本整体コース（30分）</option>
                            <option value="standard60">スタンダード整体コース（60分）</option>
                            <option value="premium90">プレミアム整体コース（90分）</option>
                            <option value="fullbody120">フルボディケアコース（120分）</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">オプションメニュー</span>
                        </label>
                        <select class="select select-bordered w-full" id="chartOptionMenu">
                            <option value="">選択してください</option>
                            <option value="head">ヘッドマッサージ</option>
                            <option value="foot">フットケア</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">担当者</span>
                        </label>
                        <select class="select select-bordered w-full" id="chartStaff">
                            <option value="">担当者を選択</option>
                            <option value="tanaka">田中 太郎</option>
                            <option value="yamada">山田 花子</option>
                            <option value="sato">佐藤 次郎</option>
                            <option value="suzuki">鈴木 美咲</option>
                        </select>
                    </div>
                </div>

                <!-- 右側：詳細情報 -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-base border-b pb-2">詳細情報</h4>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">備考</span>
                        </label>
                        <textarea class="textarea textarea-bordered h-24" placeholder="早整体を6.0分で施術しますが内容的に疲れだのでゆっくり口コースにしてください" id="chartNotes"></textarea>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">顧客メモ</span>
                        </label>
                        <textarea class="textarea textarea-bordered h-24" placeholder="実際に三宮から高速へ 2階5階のお客さん" id="chartCustomerNotes"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">来店時間</span>
                            </label>
                            <input type="time" class="input input-bordered w-full" id="chartArrivalTime" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">退店時間</span>
                            </label>
                            <input type="time" class="input input-bordered w-full" id="chartDepartureTime" />
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">ステータス</span>
                        </label>
                        <div class="flex gap-2">
                            <label class="label cursor-pointer">
                                <input type="radio" name="chartStatus" value="scheduled" class="radio radio-primary" checked />
                                <span class="label-text ml-2">予約済み</span>
                            </label>
                            <label class="label cursor-pointer">
                                <input type="radio" name="chartStatus" value="arrived" class="radio radio-success" />
                                <span class="label-text ml-2">来店済み</span>
                            </label>
                            <label class="label cursor-pointer">
                                <input type="radio" name="chartStatus" value="completed" class="radio radio-info" />
                                <span class="label-text ml-2">完了</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-error btn-outline">
                        <i class="fas fa-times mr-1"></i>
                        閉じる
                    </button>
                    <button class="btn btn-warning" type="button" onclick="cancelSchedule()">
                        <i class="fas fa-edit mr-1"></i>
                        キャンセルする
                    </button>
                    <button class="btn btn-success" onclick="savePatientChart()">
                        <i class="fas fa-save mr-1"></i>
                        保存する
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- スケジュール登録モーダル -->
    <dialog id="scheduleModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-calendar-plus mr-2 text-primary"></i>
                スケジュール登録
            </h3>
            
            <div class="space-y-4">
                <!-- 基本情報 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">日時</span>
                        </label>
                        <div class="flex gap-2">
                            <input type="date" class="input input-bordered flex-1" id="scheduleDate" />
                            <input type="time" class="input input-bordered w-32" id="scheduleTime" />
                        </div>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">担当者</span>
                        </label>
                        <select class="select select-bordered w-full" id="scheduleStaff">
                            <option value="">担当者を選択</option>
                            <option value="tanaka">田中 太郎</option>
                            <option value="yamada">山田 花子</option>
                            <option value="sato">佐藤 次郎</option>
                            <option value="suzuki">鈴木 美咲</option>
                            <option value="equipment">機器・設備</option>
                        </select>
                    </div>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">お客様名</span>
                    </label>
                    <input type="text" placeholder="お客様名を入力" class="input input-bordered w-full" id="scheduleCustomerName" />
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">メニュー・料金</span>
                    </label>
                    <input type="text" placeholder="例: [6,300円] 早割 整体60分 店舗予約価格" class="input input-bordered w-full" id="scheduleMenu" />
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">備考・特記事項</span>
                    </label>
                    <textarea class="textarea textarea-bordered h-24" placeholder="備考があれば入力してください" id="scheduleNotes"></textarea>
                </div>
            </div>

            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-ghost">キャンセル</button>
                    <button class="btn btn-primary" onclick="saveSchedule()">
                        <i class="fas fa-save mr-1"></i>
                        登録する
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- 編集モーダル -->
    <dialog id="editProviderModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">
                <i class="fas fa-edit mr-2 text-success"></i>
                サービス提供者編集
            </h3>
            
            <div class="space-y-4">
                <!-- タイプ表示 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">タイプ</span>
                    </label>
                    <div class="flex items-center gap-2">
                        <div id="editProviderTypeIcon" class="w-8 h-8 rounded-full bg-base-300 flex items-center justify-center">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <span id="editProviderTypeText" class="text-base-content">スタッフ</span>
                    </div>
                </div>

                <!-- 名前 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">名前</span>
                    </label>
                    <input type="text" placeholder="名前を入力してください" class="input input-bordered w-full" id="editProviderName" />
                </div>

                <!-- 説明 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">説明</span>
                    </label>
                    <textarea class="textarea textarea-bordered" placeholder="説明を入力してください" id="editProviderDescription"></textarea>
                </div>

                <!-- 統計情報（読み取り専用） -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">登録顧客数</div>
                        <div class="stat-value text-lg" id="editCustomerCount">0</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">今月カルテ数</div>
                        <div class="stat-value text-lg" id="editMonthlyCharts">0</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">新規顧客数</div>
                        <div class="stat-value text-lg" id="editNewCustomers">0</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg p-3">
                        <div class="stat-title text-xs">リピート率</div>
                        <div class="stat-value text-lg" id="editRepeatRate">0%</div>
                    </div>
                </div>

                <!-- 設定 -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">目標リピート率（%）</span>
                    </label>
                    <input type="number" placeholder="50" class="input input-bordered w-full" id="editTargetRepeatRate" />
                </div>

                <!-- ステータス -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">ステータス</span>
                    </label>
                    <select class="select select-bordered w-full" id="editProviderStatus">
                        <option value="active">アクティブ</option>
                        <option value="inactive">非アクティブ</option>
                        <option value="maintenance">メンテナンス中</option>
                    </select>
                </div>
            </div>

            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-error btn-outline" onclick="deleteProvider()">
                        <i class="fas fa-trash mr-1"></i>
                        削除
                    </button>
                    <button class="btn btn-ghost">キャンセル</button>
                    <button class="btn btn-success" onclick="saveEditProvider()">
                        <i class="fas fa-save mr-1"></i>
                        更新する
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        // 現在の表示状態を管理
        let currentView = 'dashboard';
        let currentDate = new Date('2025-07-16');
        let calendarViewType = 'day'; // day, week, month
        let weekStartDate = new Date('2025-07-13'); // 週の開始日
        let weekEndDate = new Date('2025-07-19'); // 週の終了日
        // 表示モードごとに表示設定を独立管理
        let viewTypeByMode = { day: 'all', week: 'all', month: 'all' }; // 'all' | 'room' | 'staff'
        let staffFilterByMode = { day: '', week: '', month: '' };

        // ページ読み込み時に前回の状態を復元
        document.addEventListener('DOMContentLoaded', function() {
            // 初期表示状態を設定
            changeCalendarView();
            restoreViewState();
            // 問診票一覧の初期化
            renderQuestionnaires();
        });

        // 表示状態を保存
        function saveViewState() {
            const state = {
                currentView: currentView,
                currentDate: currentDate.toISOString(),
                weekStartDate: weekStartDate.toISOString(),
                weekEndDate: weekEndDate.toISOString(),
                calendarViewType: calendarViewType,
                staffFilter: document.getElementById('staffFilter') ? document.getElementById('staffFilter').value : '',
                viewType: document.querySelector('input[name="view"]:checked') ? document.querySelector('input[name="view"]:checked').value : 'all',
                viewTypeByMode: viewTypeByMode,
                staffFilterByMode: staffFilterByMode
            };
            localStorage.setItem('scheduleViewState', JSON.stringify(state));
        }

        // 表示状態を復元
        function restoreViewState() {
            const savedState = localStorage.getItem('scheduleViewState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    
                    // 日付を復元
                    if (state.currentDate) {
                        currentDate = new Date(state.currentDate);
                    }
                    
                    // 週期間を復元
                    if (state.weekStartDate) {
                        weekStartDate = new Date(state.weekStartDate);
                    }
                    if (state.weekEndDate) {
                        weekEndDate = new Date(state.weekEndDate);
                    }
                    
                    // カレンダー表示形式を復元
                    if (state.calendarViewType) {
                        calendarViewType = state.calendarViewType;
                        const calendarRadio = document.querySelector(`input[name="calendarView"][value="${state.calendarViewType}"]`);
                        if (calendarRadio) {
                            calendarRadio.checked = true;
                        }
                    }
                    // モード別設定を復元
                    if (state.viewTypeByMode) viewTypeByMode = state.viewTypeByMode;
                    if (state.staffFilterByMode) staffFilterByMode = state.staffFilterByMode;
                    
                    // 表示画面を復元
                    if (state.currentView === 'schedule') {
                        showScheduleManagement();
                        
                        // スタッフフィルターを復元
                        syncControlsToMode();
                        
                        // 表示形式を復元
                        if (state.viewType) {
                            const viewRadio = document.querySelector(`input[name="view"][value="${state.viewType}"]`);
                            if (viewRadio) {
                                viewRadio.checked = true;
                            }
                        }
                        
                        // 日付選択を更新
                        updateDatePicker();
                        updateWeekRangePicker();
                        
                        // 日付表示を更新
                        updateDateDisplay();
                        
                        // スケジュール表示を更新
                        setTimeout(() => {
                            updateScheduleView();
                        }, 100);
                    } else if (state.currentView) {
                        // 他の画面も復元可能にする
                        switch(state.currentView) {
                            case 'dashboard':
                                showDashboard();
                                break;
                            case 'reservation':
                                showReservationManagement();
                                break;
                            case 'customer':
                                showCustomerInfo();
                                break;
                            case 'reception':
                                showReceptionList();
                                break;
                            case 'schedule':
                                showScheduleManagement();
                                break;
                            case 'reviews':
                                showReviews();
                                break;
                            case 'staff':
                                showStaffManagement();
                                break;
                            case 'menu':
                                showMenuManagement();
                                break;
                            case 'reports':
                                showReports();
                                break;
                            case 'settings':
                                showSettings();
                                break;
                            case 'questionnaire_detail':
                                showQuestionnaireDetail();
                                break;
                            default:
                                showDashboard();
                        }
                        // 画面切替後にコントロール同期
                        syncControlsToMode();
                    } else {
                        showDashboard();
                    }
                } catch (e) {
                    console.error('状態復元エラー:', e);
                    showDashboard();
                }
            }
        }

        // ローカルタイムで YYYY-MM-DD を返す（UTCズレ防止）
        function formatLocalDate(date) {
            const d = (date instanceof Date) ? date : new Date(date);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // 現在のモードの設定をUIに同期
        function syncControlsToMode(){
            const desiredView = viewTypeByMode[calendarViewType] || 'all';
            const radio = document.querySelector(`input[name="view"][value="${desiredView}"]`);
            if (radio) radio.checked = true;
            const sel = document.getElementById('staffFilter');
            if (sel) sel.value = staffFilterByMode[calendarViewType] || '';
        }

        // ページ切り替え関数
        function showDashboard() {
            hideAllContent();
            document.getElementById('dashboardContent').classList.remove('hidden');
            updateActiveMenu('dashboard');
            currentView = 'dashboard';
            saveViewState();
        }

        function showScheduleManagement() {
            hideAllContent();
            document.getElementById('scheduleContent').classList.remove('hidden');
            updateActiveMenu('schedule');
            currentView = 'schedule';
            // 初期表示を更新
            updateDatePicker();
            updateWeekRangePicker();
            updateDateDisplay();
            updateScheduleView();
            saveViewState();
        }

        function showReservationManagement() {
            hideAllContent();
            updateActiveMenu('reservation');
            currentView = 'reservation';
            saveViewState();
            alert('予約管理画面は準備中です');
        }

        // 問診票一覧表示
        function showQuestionnaires() {
            hideAllContent();
            const el = document.getElementById('questionnairesContent');
            if (el) el.classList.remove('hidden');
            currentView = 'questionnaires';
            renderQuestionnaires();
            saveViewState();
        }
        function showQuestionnaireDetail(){
            hideAllContent();
            const el = document.getElementById('questionnaireDetailContent');
            if (el) el.classList.remove('hidden');
            currentView = 'questionnaire_detail';
            saveViewState();
        }
        function showQuestionnaireBuilder(){
            hideAllContent();
            const el = document.getElementById('questionnaireBuilderContent');
            if (el) el.classList.remove('hidden');
            currentView = 'questionnaire_builder';
            initQuestionnaireBuilder();
        }
        function backToQuestionnaires(){
            showQuestionnaires();
        }

        function showCustomerInfo() {
            hideAllContent();
            updateActiveMenu('customer');
            currentView = 'customer';
            saveViewState();
            alert('顧客情報画面は準備中です');
        }

        function showReceptionList() {
            hideAllContent();
            updateActiveMenu('reception');
            currentView = 'reception';
            saveViewState();
            alert('受付一覧画面は準備中です');
        }

        function showReviews() {
            hideAllContent();
            updateActiveMenu('reviews');
            currentView = 'reviews';
            saveViewState();
            alert('口コミ画面は準備中です');
        }

        function showStaffManagement() {
            hideAllContent();
            updateActiveMenu('staff');
            currentView = 'staff';
            saveViewState();
            alert('スタッフ管理画面は準備中です');
        }

        function showMenuManagement() {
            hideAllContent();
            const el = document.getElementById('menuManagementContent');
            if (el) el.classList.remove('hidden');
            updateActiveMenu('menu');
            currentView = 'menu';
            saveViewState();
        }

        // 追加: 表示切替（店舗情報/サービス提供者/問診票）
        function showClinicInfo(){
            hideAllContent();
            const el = document.getElementById('clinicInfoContent');
            if (el) el.classList.remove('hidden');
        }

        function showServiceProviders(){
            hideAllContent();
            const el = document.getElementById('serviceProvidersContent');
            if (el) el.classList.remove('hidden');
        }

        function showQuestionnaires(){
            hideAllContent();
            const el = document.getElementById('questionnairesContent');
            if (el) el.classList.remove('hidden');
        }

        function showReports() {
            hideAllContent();
            updateActiveMenu('reports');
            currentView = 'reports';
            saveViewState();
            alert('レポート画面は準備中です');
        }

        function showSettings() {
            hideAllContent();
            const el = document.getElementById('settingsContent');
            if (el) el.classList.remove('hidden');
        }

        // 問診票一覧表示
        function hideAllContent() {
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('scheduleContent').classList.add('hidden');
            const q = document.getElementById('questionnairesContent');
            if (q) q.classList.add('hidden');
            const d = document.getElementById('questionnaireDetailContent');
            if (d) d.classList.add('hidden');
            const b = document.getElementById('questionnaireBuilderContent');
            if (b) b.classList.add('hidden');
            const m = document.getElementById('menuManagementContent');
            if (m) m.classList.add('hidden');
            const me = document.getElementById('menuEditContent');
            if (me) me.classList.add('hidden');
            const c = document.getElementById('clinicInfoContent');
            if (c) c.classList.add('hidden');
            const sp = document.getElementById('serviceProvidersContent');
            if (sp) sp.classList.add('hidden');
        }

        function updateActiveMenu(activeView) {
            // すべてのメニューからアクティブクラスを削除
            document.querySelectorAll('.menu a').forEach(link => {
                link.classList.remove('menu-active');
            });

            // 対応するメニューにアクティブクラスを追加
            switch(activeView) {
                case 'dashboard':
                    document.querySelector('a[onclick="showDashboard()"]').classList.add('menu-active');
                    break;
                case 'reservation':
                    document.querySelector('a[onclick="showReservationManagement()"]').classList.add('menu-active');
                    break;
                case 'customer':
                    document.querySelector('a[onclick="showCustomerInfo()"]').classList.add('menu-active');
                    break;
                case 'reception':
                    document.querySelector('a[onclick="showReceptionList()"]').classList.add('menu-active');
                    break;
                case 'schedule':
                    document.querySelector('a[onclick="showScheduleManagement()"]').classList.add('menu-active');
                    break;
                case 'reviews':
                    document.querySelector('a[onclick="showReviews()"]').classList.add('menu-active');
                    break;
                case 'staff':
                    document.querySelector('a[onclick="showStaffManagement()"]').classList.add('menu-active');
                    break;
                case 'menu':
                    document.querySelectorAll('a[onclick="showMenuManagement()"]').forEach(a=>a.classList.add('menu-active'));
                    break;
                case 'questionnaires':
                    document.querySelector('a[onclick="showQuestionnaires()"]').classList.add('menu-active');
                    break;
                case 'reports':
                    document.querySelector('a[onclick="showReports()"]').classList.add('menu-active');
                    break;
                case 'settings':
                    document.querySelector('a[onclick="showSettings()"]').classList.add('menu-active');
                    break;
            }
        }

        // スケジュール管理関連の関数
        function previousPeriod() {
            if (calendarViewType === 'day') {
                currentDate.setDate(currentDate.getDate() - 1);
                updateDatePicker();
            } else if (calendarViewType === 'week') {
                weekStartDate.setDate(weekStartDate.getDate() - 7);
                weekEndDate.setDate(weekEndDate.getDate() - 7);
                updateWeekRangePicker();
            } else if (calendarViewType === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateDatePicker();
            }
            updateDateDisplay();
            updateScheduleView();
            saveViewState();
        }

        function nextPeriod() {
            if (calendarViewType === 'day') {
                currentDate.setDate(currentDate.getDate() + 1);
                updateDatePicker();
            } else if (calendarViewType === 'week') {
                weekStartDate.setDate(weekStartDate.getDate() + 7);
                weekEndDate.setDate(weekEndDate.getDate() + 7);
                updateWeekRangePicker();
            } else if (calendarViewType === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateDatePicker();
            }
            updateDateDisplay();
            updateScheduleView();
            saveViewState();
        }

        // 旧関数との互換性のため残す
        function previousDay() {
            previousPeriod();
        }

        function nextDay() {
            nextPeriod();
        }

        function updateDateDisplay() {
            let dateStr = '';
            const badge = document.getElementById('currentDateBadge');
            
            if (calendarViewType === 'day') {
                const options = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'short' 
                };
                dateStr = currentDate.toLocaleDateString('ja-JP', options);
            } else if (calendarViewType === 'week') {
                const startStr = weekStartDate.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                const endStr = weekEndDate.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
                const year = weekStartDate.getFullYear();
                dateStr = `${year}年 ${startStr} - ${endStr}`;
            } else if (calendarViewType === 'month') {
                const options = { 
                    year: 'numeric', 
                    month: 'long'
                };
                dateStr = currentDate.toLocaleDateString('ja-JP', options);
            }
            
            if (badge) {
                badge.innerHTML = `
                    <i class="fas fa-calendar mr-1"></i>
                    ${dateStr}
                `;
            }
        }

        // 日付選択器の更新
        function updateDatePicker() {
            const datePicker = document.getElementById('datePicker');
            if (datePicker) {
                datePicker.value = formatLocalDate(currentDate);
            }
        }

        // カレンダー表示形式の変更
        function changeCalendarView() {
            const selectedView = document.querySelector('input[name="calendarView"]:checked');
            if (selectedView) {
                calendarViewType = selectedView.value;
                
                // 表示形式に応じて日付選択器を切り替え
                const datePicker = document.getElementById('datePicker');
                const weekRangePicker = document.getElementById('weekRangePicker');
                
                if (calendarViewType === 'day') {
                    datePicker.classList.remove('hidden');
                    weekRangePicker.classList.add('hidden');
                } else if (calendarViewType === 'week') {
                    datePicker.classList.add('hidden');
                    weekRangePicker.classList.remove('hidden');
                } else if (calendarViewType === 'month') {
                    datePicker.classList.add('hidden');
                    weekRangePicker.classList.add('hidden');
                }
                
                // モード固有のUI状態を反映
                syncControlsToMode();
                updateDateDisplay();
                updateScheduleView();
                saveViewState();
            }
        }

        // 日付選択の変更
        function changeSelectedDate() {
            const datePicker = document.getElementById('datePicker');
            if (datePicker && datePicker.value) {
                currentDate = new Date(datePicker.value);
                updateDateDisplay();
                updateScheduleView();
                saveViewState();
            }
        }

        // 週期間選択の変更
        function changeWeekRange() {
            const startDateInput = document.getElementById('weekStartDate');
            const endDateInput = document.getElementById('weekEndDate');
            
            if (startDateInput && startDateInput.value) {
                weekStartDate = new Date(startDateInput.value);
                // 終了日が設定されていない場合は7日後に設定
                if (!endDateInput.value) {
                    const endDate = new Date(weekStartDate);
                    endDate.setDate(endDate.getDate() + 6);
                    weekEndDate = endDate;
                    endDateInput.value = formatLocalDate(weekEndDate);
                }
            }
            
            if (endDateInput && endDateInput.value) {
                weekEndDate = new Date(endDateInput.value);
                // 開始日が設定されていない場合は終了日から6日前に設定
                if (!startDateInput.value) {
                    const startDate = new Date(weekEndDate);
                    startDate.setDate(startDate.getDate() - 6);
                    weekStartDate = startDate;
                    startDateInput.value = formatLocalDate(weekStartDate);
                }
            }
            
            updateDateDisplay();
            updateScheduleView();
            saveViewState();
        }

        // 週期間選択器の更新
        function updateWeekRangePicker() {
            const startDateInput = document.getElementById('weekStartDate');
            const endDateInput = document.getElementById('weekEndDate');
            
            if (startDateInput) {
                startDateInput.value = formatLocalDate(weekStartDate);
            }
            if (endDateInput) {
                endDateInput.value = formatLocalDate(weekEndDate);
            }
        }

        // スケジュール表示更新関数
        function updateScheduleView() {
            // ユーザー操作による変更を現在モードに反映
            const selectedViewType = document.querySelector('input[name="view"]:checked')?.value || 'all';
            const selectedStaffFilter = document.getElementById('staffFilter')?.value || '';
            viewTypeByMode[calendarViewType] = selectedViewType;
            staffFilterByMode[calendarViewType] = selectedStaffFilter;
            const viewType = viewTypeByMode[calendarViewType];
            const staffFilter = staffFilterByMode[calendarViewType];
            
            // 日付表示の切り替え
            const currentDateBadge = document.getElementById('currentDateBadge');
            const weekDateRange = document.getElementById('weekDateRange');
            const table = document.querySelector('table.schedule-table');
            
            if (calendarViewType === 'day') {
                currentDateBadge.style.display = 'block';
                weekDateRange.style.display = 'none';
                if (table) table.classList.remove('month-mode');
                updateScheduleTable(viewType, staffFilter);
            } else if (calendarViewType === 'week') {
                currentDateBadge.style.display = 'none';
                weekDateRange.style.display = 'block';
                if (table) table.classList.remove('month-mode');
                updateWeekView(viewType, staffFilter);
            } else if (calendarViewType === 'month') {
                currentDateBadge.style.display = 'block';
                weekDateRange.style.display = 'none';
                if (table) table.classList.add('month-mode');
                updateMonthView(viewType, staffFilter);
            }
            
            saveViewState();
        }

        // 週表示の日付範囲を更新する関数
        function updateWeekDateRange(startDate, endDate) {
            const startStr = startDate.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'numeric', 
                day: 'numeric', 
                weekday: 'short' 
            });
            const endStr = endDate.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'numeric', 
                day: 'numeric', 
                weekday: 'short' 
            });
            
            const weekDateRangeText = document.getElementById('weekDateRangeText');
            if (weekDateRangeText) {
                weekDateRangeText.textContent = `${startStr} - ${endStr}`;
            }
        }

        // 週ナビゲーション機能
        function navigateWeek(direction) {
            const currentWeekStart = new Date(weekStartDate);
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            const currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);

            // Date オブジェクトのまま保持
            weekStartDate = currentWeekStart;
            weekEndDate = currentWeekEnd;

            // UI更新
            updateWeekRangePicker();
            updateWeekDateRange(weekStartDate, weekEndDate);
            if (calendarViewType === 'week') {
                const viewType = document.querySelector('input[name="view"]:checked').value;
                const staffFilter = document.getElementById('staffFilter').value;
                updateWeekView(viewType, staffFilter);
            }
            saveViewState();
        }

        // 予約の時間から高さと位置を計算する関数
        function calculateReservationPosition(reservationTime, baseTime) {
            // reservationTime: "15:00-16:20", baseTime: "15:00"
            const [startTime, endTime] = reservationTime.split('-');
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            const [baseHour, baseMin] = baseTime.split(':').map(Number);
            
            // 1時間 = 120px として計算
            const pixelsPerHour = 120;
            const pixelsPerMinute = pixelsPerHour / 60;
            
            // 開始時間からのオフセット（分）
            const startOffsetMinutes = (startHour - baseHour) * 60 + (startMin - baseMin);
            const top = Math.max(0, startOffsetMinutes * pixelsPerMinute);
            
            // 予約の継続時間（分）
            const durationMinutes = (endHour - startHour) * 60 + (endMin - startMin);
            const height = Math.max(20, durationMinutes * pixelsPerMinute); // 最小20px
            
            return { top, height };
        }

        function updateScheduleTable(viewType, staffFilter) {
            const tableHead = document.getElementById('scheduleTableHead');
            const tableBody = document.getElementById('scheduleTableBody');
            
            // スタッフデータ
            const staffData = {
                tanaka: { name: '田中 太郎', color: 'bg-green-500' },
                yamada: { name: '山田 花子', color: 'bg-blue-500' },
                sato: { name: '佐藤 次郎', color: 'bg-purple-500' },
                suzuki: { name: '鈴木 美咲', color: 'bg-pink-500' }
            };

            // サンプル予約データ（削除）
            const reservations = {};

            // ヘッダーを更新
            let headerHTML = '<tr class="bg-base-200"><th class="w-20 text-center">時間</th>';
            
            if (viewType === 'room') {
                headerHTML += '<th class="text-center">予約枠</th>';
            } else if (viewType === 'staff') {
                if (staffFilter) {
                    headerHTML += `<th class="text-center">${staffData[staffFilter].name}</th>`;
                } else {
                    Object.values(staffData).forEach(staff => {
                        headerHTML += `<th class="text-center">${staff.name}</th>`;
                    });
                }
            } else { // all
                headerHTML += '<th class="text-center">予約枠</th>';
                Object.values(staffData).forEach(staff => {
                    headerHTML += `<th class="text-center">${staff.name}</th>`;
                });
            }
            
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // ボディを更新（10:00〜19:00を1時間ごとに行として表示）
            const timeSlots = ['10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00'];
            let bodyHTML = '';

            timeSlots.forEach(time => {
                bodyHTML += `<tr class="border-b border-base-300">`;
                bodyHTML += `<td class="text-center font-mono text-sm bg-base-50">${time}</td>`;
                
                if (viewType === 'room') {
                        bodyHTML += `<td class="p-2 relative day-hour-cell" onclick="handleTimeCellClick(event, '${time}')">
                            <div class="time-cell"></div>
                        </td>`;
                } else if (viewType === 'staff') {
                    const staffsToShow = staffFilter ? [staffFilter] : Object.keys(staffData);
                    staffsToShow.forEach(() => {
                            bodyHTML += `<td class="p-2 relative day-hour-cell" onclick="handleTimeCellClick(event, '${time}')">
                                <div class="time-cell"></div>
                            </td>`;
                    });
                } else { // all
                        bodyHTML += `<td class="p-2 relative day-hour-cell" onclick="handleTimeCellClick(event, '${time}')">
                            <div class="time-cell"></div>
                        </td>`;
                    Object.keys(staffData).forEach(() => {
                            bodyHTML += `<td class="p-2 relative day-hour-cell" onclick="handleTimeCellClick(event, '${time}')">
                                <div class="time-cell"></div>
                            </td>`;
                    });
                }
                
                bodyHTML += '</tr>';
            });

            tableBody.innerHTML = bodyHTML;
            // 保存済みスケジュールを反映
            if (typeof loadSavedSchedules === 'function') {
                loadSavedSchedules();
            }
        }

        function getEndTime(startTime, duration) {
            const [hours, minutes] = startTime.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(hours, minutes + duration, 0, 0);
            return endDate.toTimeString().slice(0, 5);
        }

        // Notion風：セル内クリック位置から時間を算出してモーダルを開く
        function handleTimeCellClick(event, baseTime) {
            // baseTime は行の開始時刻（例: "14:00"）
            const cell = event.currentTarget;
            const rect = cell.getBoundingClientRect();
            const y = event.clientY - rect.top; // セル内のY位置
            const height = rect.height; // セル高（80px固定想定）

            // セルを60分として、クリック位置を分に変換（0-59）
            const minutesFromTop = Math.max(0, Math.min(59, Math.round((y / height) * 60)));

            // 5分刻みに丸める
            const rounded = Math.round(minutesFromTop / 5) * 5;

            const [h, m] = baseTime.split(':').map(Number);
            const start = new Date();
            start.setHours(h, m + rounded, 0, 0);
            const hh = String(start.getHours()).padStart(2, '0');
            const mm = String(start.getMinutes()).padStart(2, '0');

            // 統一スケジュールモーダルを使用
            const today = formatLocalDate(currentDate);
            document.getElementById('scheduleDate').value = today;
            document.getElementById('scheduleTime').value = `${hh}:${mm}`;
            document.getElementById('scheduleStaff').value = '';
            document.getElementById('scheduleCustomerName').value = '';
            document.getElementById('scheduleMenu').value = '';
            document.getElementById('scheduleNotes').value = '';
            document.getElementById('scheduleModal').showModal();
        }

        // 週表示の更新
        function updateWeekView(viewType, staffFilter) {
            const tableHead = document.getElementById('scheduleTableHead');
            const tableBody = document.getElementById('scheduleTableBody');
            
            // 週の開始日と終了日を使用
            const startOfWeek = new Date(weekStartDate);
            const endOfWeek = new Date(weekEndDate);
            
            // 週表示の日付範囲を更新
            updateWeekDateRange(startOfWeek, endOfWeek);
            
            // スタッフデータ
            const staffData = {
                tanaka: { name: '田中 太郎', color: 'bg-green-500' },
                yamada: { name: '山田 花子', color: 'bg-blue-500' },
                sato: { name: '佐藤 次郎', color: 'bg-purple-500' },
                suzuki: { name: '鈴木 美咲', color: 'bg-pink-500' }
            };

            // サンプル予約データ（削除）
            const weekReservations = {};

            // ヘッダーを作成（曜日表示）
            let headerHTML = '<tr class="bg-base-200"><th class="w-20 text-center">時間</th>';
            
            // 週の日数を計算
            const daysDiff = Math.ceil((endOfWeek - startOfWeek) / (1000 * 60 * 60 * 24)) + 1;
            const daysToShow = Math.min(daysDiff, 7); // 最大7日まで表示
            
            for (let i = 0; i < daysToShow; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = date.toLocaleDateString('ja-JP', { weekday: 'short' });
                const dayStr = `${month}/${day} (${weekday})`;
                headerHTML += `<th class="text-center">${dayStr}</th>`;
            }
            
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // ボディを作成（10:00-19:00の時間枠）
            const timeSlots = ['10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];
            let bodyHTML = '';

            timeSlots.forEach(time => {
                bodyHTML += `<tr class="border-b border-gray-200">`;
                bodyHTML += `<td class="text-center font-mono text-sm bg-base-50 border-0">${time}</td>`;
                
                // 各曜日の予約を表示
                for (let i = 0; i < daysToShow; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    const dateStr = formatLocalDate(date);
                    
                    // その日のすべての予約を取得して、現在の時間スロットの行に開始が属するものを表示
                    const dayReservations = weekReservations[dateStr] || {};
                    const currentTimeReservations = [];
                    const [rowH, rowM] = time.split(':').map(Number);
                    const rowStart = rowH * 60 + rowM;
                    const rowEnd = rowStart + 60;
                    
                    Object.keys(dayReservations).forEach(reservationKey => {
                        const reservations = dayReservations[reservationKey];
                        reservations.forEach(reservation => {
                            if (!reservation.time) return;
                            const [st, et] = reservation.time.split('-');
                            const [sh, sm] = st.split(':').map(Number);
                            const startMin = sh * 60 + sm;
                            // 開始がこの行範囲に含まれるものをこの行に描画
                            if (startMin >= rowStart && startMin < rowEnd) {
                                currentTimeReservations.push(reservation);
                            }
                        });
                    });
                    
                    if (currentTimeReservations.length > 0) {
                        bodyHTML += `<td class="p-1 relative border-0" style="height: 120px;">
                            <div class="relative w-full h-full">`;
                        
                        // 複数の予約を表示（最大2つまで）
                        currentTimeReservations.slice(0, 2).forEach((reservation, index) => {
                            if (reservation.name && reservation.name.trim() !== '') {
                                const staffClass = `staff-${reservation.staff}`;
                                
                                // 予約の時間から高さと位置を計算
                                const timeInfo = calculateReservationPosition(reservation.time, time);
                                
                            bodyHTML += `
                                    <div class="${staffClass} schedule-card text-white rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer absolute" 
                                         style="top: ${timeInfo.top}px; height: ${timeInfo.height}px; width: calc(100% - 8px); z-index: 10;"
                                     onclick="openPatientChart('${reservation.name}', '${dateStr}', '${time}')">
                                        <i class="fas fa-edit edit-icon text-xs"></i>
                                        <div class="text-sm font-semibold mb-1">予約あり</div>
                                        <div class="text-xs mb-1">${reservation.time}</div>
                                        <div class="text-xs mb-1">${reservation.location}</div>
                                        <div class="text-xs mb-1">${reservation.menu}</div>
                                        ${reservation.price ? `<div class="text-xs opacity-90">${reservation.price}</div>` : ''}
                                </div>`;
                            }
                        });
                        
                        // 2つ以上ある場合は「+n件」を表示
                        if (currentTimeReservations.length > 2) {
                            bodyHTML += `<div class="text-xs text-gray-600 absolute bottom-0 left-1">+${currentTimeReservations.length - 2}件</div>`;
                        }
                        
                        bodyHTML += `</div>
                        </td>`;
                    } else {
                        // 空の時間枠はクリック可能にしてスケジュール追加
                        bodyHTML += `<td class="p-1 relative border-0" style="height: 120px;" onclick="openWeekScheduleModal('${dateStr}', '${time}')">
                            <div class="h-full cursor-pointer rounded">
                            </div>
                        </td>`;
                    }
                }
                
                bodyHTML += '</tr>';
            });

            tableBody.innerHTML = bodyHTML;

            // 保存済みスケジュール（localStorage）も週表示に描画
            try { loadSavedSchedulesWeek(startOfWeek, endOfWeek); } catch(e) { console.warn(e); }
        }

        // 月表示の更新
        function updateMonthView(viewType, staffFilter) {
            const tableHead = document.getElementById('scheduleTableHead');
            const tableBody = document.getElementById('scheduleTableBody');
            
            // 月の最初の日と最後の日を計算
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // 月の最初の週の日曜日を計算
            const startDate = new Date(year, month, 1 - firstDay.getDay());

            // スタッフデータ
            const staffData = {
                tanaka: { name: '田中 太郎', color: 'bg-green-500' },
                yamada: { name: '山田 花子', color: 'bg-blue-500' },
                sato: { name: '佐藤 次郎', color: 'bg-purple-500' },
                suzuki: { name: '鈴木 美咲', color: 'bg-pink-500' }
            };

            // サンプル予約データ（月表示用）削除
            const monthReservations = {};

            // ヘッダーを作成（曜日表示）
            let headerHTML = '<tr class="bg-base-200">';
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                headerHTML += `<th class="text-center">${day}</th>`;
            });
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // ボディを作成（カレンダー形式）
            let bodyHTML = '';
            let currentWeekDate = new Date(startDate);
            
            // 6週間分表示（必要に応じて5週で終了）
            for (let week = 0; week < 6; week++) {
                bodyHTML += '<tr class="border-b border-base-300">';
                
                for (let day = 0; day < 7; day++) {
                    const isCurrentMonth = currentWeekDate.getMonth() === month;
                    const dayNum = currentWeekDate.getDate();
                    // ローカル基準のYYYY-MM-DD（TZずれ対策）
                    const yyyy = currentWeekDate.getFullYear();
                    const mm = String(currentWeekDate.getMonth() + 1).padStart(2,'0');
                    const dd = String(currentWeekDate.getDate()).padStart(2,'0');
                    const dateStr = `${yyyy}-${mm}-${dd}`;
                    
                    // その日の予約を取得
                    const dayReservations = monthReservations[dateStr] || [];
                    
                    let cellClass = 'p-2 relative h-32 align-top';
                    if (!isCurrentMonth) {
                        cellClass += ' text-gray-400 bg-gray-50';
                    }
                    
                    bodyHTML += `<td class="${cellClass}">
                        <div class="day-number">${dayNum}</div>
                        <div class="day-content">`;
                    
                    if (dayReservations.length > 0) {
                        const count = dayReservations.length;
                        const maxShow = 2;
                        const needsExpand = count > maxShow;
                        bodyHTML += `<div class="space-y-1 ${needsExpand ? 'pb-2' : ''}" style="min-height:${needsExpand ? '6.5rem' : '4.5rem'}">`;

                        dayReservations.slice(0, maxShow).forEach((reservation) => {
                            const color = staffData[reservation.staff]?.color || 'bg-green-500';
                            bodyHTML += `<div class="${color} text-white text-xs p-1 rounded cursor-pointer hover:shadow-lg transition-shadow" onclick="openPatientChart('${reservation.name||''}', '${dateStr}', '${reservation.time||''}')">
                                <div class="font-semibold">${reservation.name||''}</div>
                                <div class="opacity-90">${reservation.time||''} ${reservation.menu||''}</div>
                            </div>`;
                        });
                        
                        if (needsExpand) {
                            const rest = count - maxShow;
                            bodyHTML += `<div class="text-xs text-gray-600">+${rest}件</div>`;
                        }
                        
                        bodyHTML += `</div>`;
                    } else if (isCurrentMonth) {
                        // 空の日はクリック可能にしてスケジュール追加（左寄せ・ホバーなし）
                        bodyHTML += `<div class="day-content"><div class="h-full cursor-pointer rounded add-placeholder" onclick="openMonthScheduleModal('${dateStr}')">
                            <span class="text-gray-400 text-xs">追加</span>
                        </div></div>`;
                    }
                    
                    bodyHTML += '</div></td>';
                    
                    currentWeekDate.setDate(currentWeekDate.getDate() + 1);
                }
                
                bodyHTML += '</tr>';
                
                // 月が変わったら（6行目以降に）終了
                if (currentWeekDate.getMonth() !== month && week >= 4) break;
            }

            tableBody.innerHTML = bodyHTML;

            // 保存済みスケジュール（localStorage）も月表示に描画
            try { loadSavedSchedulesMonth(year, month); } catch(e) { console.warn(e); }
        }

        // 週表示: localStorageのスケジュールを反映
        function loadSavedSchedulesWeek(startOfWeek, endOfWeek) {
            const tableBody = document.getElementById('scheduleTableBody');
            if (!tableBody) return;

            // date -> column index のマップを作成（0..6）
            const dayIndexMap = {};
            const daysDiff = Math.ceil((endOfWeek - startOfWeek) / (1000 * 60 * 60 * 24)) + 1;
            const daysToShow = Math.min(daysDiff, 7);
            for (let i = 0; i < daysToShow; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                const key = formatLocalDate(d);
                dayIndexMap[key] = i; // 0..6
            }

            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const getRowByBaseTime = (baseTime) => rows.find(tr => (tr.children[0] && tr.children[0].textContent.trim() === baseTime));

            Object.keys(localStorage).forEach(key => {
                if (!key.startsWith('schedule_')) return;
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (!data || !data.date || !data.time) return;
                    if (!(data.date in dayIndexMap)) return; // 週外は無視

                    const baseRowTime = `${data.time.slice(0,2)}:00`;
                    const row = getRowByBaseTime(baseRowTime);
                    if (!row) return;
                    const colIdx = 1 + dayIndexMap[data.date]; // 先頭は時間列
                    if (colIdx >= row.children.length) return;
                    const cell = row.children[colIdx];
                    const container = cell.querySelector('.relative.w-full.h-full') || cell;

                    const duration = parseInt(data.duration || '60', 10);
                    const endTime = getEndTime(data.time, duration);
                    const timeInfo = calculateReservationPosition(`${data.time}-${endTime}`, baseRowTime);
                    const staffId = (data.staff || 'tanaka').toLowerCase();
                    const staffClass = `staff-${staffId}`;

                    const div = document.createElement('div');
                    div.className = `${staffClass} schedule-card text-white rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer absolute`;
                    div.style.top = `${timeInfo.top}px`;
                    div.style.height = `${timeInfo.height}px`;
                    div.style.width = 'calc(100% - 8px)';
                    div.style.zIndex = '11';
                    div.dataset.name = data.customerName || '';
                    div.dataset.time = `${data.time} - ${endTime}`;
                    div.dataset.menu = data.menu || '';
                    div.innerHTML = `
                        <i class="fas fa-edit edit-icon text-xs"></i>
                        <div class="text-sm font-semibold mb-1">予約あり</div>
                        <div class="text-xs mb-1">${data.time} - ${endTime}</div>
                        <div class="text-xs mb-1">${getStaffName(staffId)}</div>
                        ${data.menu ? `<div class="text-xs mb-1">${data.menu}</div>` : ''}
                        ${data.notes ? `<div class="text-xs opacity-90">${data.notes}</div>` : ''}
                    `;
                    div.addEventListener('mouseover', (e) => showReservationTooltip(div, e));
                    div.addEventListener('mouseout', () => hideReservationTooltip());
                    div.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openPatientChart(data.customerName || '', data.date, data.time);
                    });
                    container.appendChild(div);
                } catch {}
            });
        }

        // 月表示: localStorageのスケジュールを反映
        function loadSavedSchedulesMonth(year, month) {
            const tableBody = document.getElementById('scheduleTableBody');
            if (!tableBody) return;

            // 月の表示開始（日曜始まり）を算出
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(firstDay.getDate() - firstDay.getDay());

            // 便利関数: セル取得（week,row day,col）
            const getCell = (weekIndex, dayIndex) => {
                const row = tableBody.rows[weekIndex];
                return row ? row.cells[dayIndex] : null;
            };

            // 日付 -> {weekIndex, dayIndex}
            const dateToCellPos = {};
            let current = new Date(startDate);
            for (let w = 0; w < tableBody.rows.length; w++) {
                for (let d = 0; d < 7; d++) {
                    const key = formatLocalDate(current);
                    dateToCellPos[key] = { w, d };
                    current.setDate(current.getDate() + 1);
                }
            }

            // スタッフ色
            const colorMap = {
                tanaka: 'bg-green-500',
                yamada: 'bg-blue-500',
                sato: 'bg-purple-500',
                suzuki: 'bg-pink-500',
                equipment: 'bg-gray-500'
            };

            // 対象月の範囲
            const monthStart = `${year}-${String(month+1).padStart(2,'0')}-01`;
            const monthEnd = `${year}-${String(month+1).padStart(2,'0')}-${String(new Date(year, month + 1, 0).getDate()).padStart(2,'0')}`;

            const inMonth = (dateStr) => {
                const [yy, mm] = dateStr.split('-');
                return Number(yy) === year && Number(mm) === (month+1);
            };

            Object.keys(localStorage).forEach(key => {
                if (!key.startsWith('schedule_')) return;
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (!data || !data.date || !data.time) return;
                    // 月表示は当該月の予定を表示
                    if (!inMonth(data.date)) return;
                    const pos = dateToCellPos[data.date];
                    if (!pos) return;
                    const cell = getCell(pos.w, pos.d);
                    if (!cell) return;

                    const staffId = (data.staff || 'tanaka').toLowerCase();
                    const color = colorMap[staffId] || 'bg-green-500';
                    const endTime = getEndTime(data.time, parseInt(data.duration || '60', 10));

                    // day-content 内に描画し、プレースホルダを除去
                    const content = cell.querySelector('.day-content') || cell;
                    const placeholder = content.querySelector('.add-placeholder');
                    if (placeholder) placeholder.remove();

                    const wrap = content.querySelector('.space-y-1') || (function(){
                        const s = document.createElement('div');
                        s.className = 'space-y-1';
                        content.appendChild(s);
                        return s;
                    })();

                    const item = document.createElement('div');
                    item.className = `${color} text-white text-xs p-1 rounded cursor-pointer hover:shadow-lg transition-shadow`;
                    item.innerHTML = `
                        <div class="font-semibold">${data.customerName || ''}</div>
                        <div class="opacity-90">${data.time} ${data.menu || ''}</div>
                    `;
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openPatientChart(data.customerName || '', data.date, data.time);
                    });
                    wrap.appendChild(item);
                } catch {}
            });
        }

        // 予約関連のグローバル変数
        let currentTooltipData = {};
        
        
        // スケジュール登録モーダル関連
        function openScheduleModal(time) {
            // 現在の日付を設定
            const today = formatLocalDate(currentDate);
            document.getElementById('scheduleDate').value = today;
            document.getElementById('scheduleTime').value = time;
            
            // フォームをリセット
            document.getElementById('scheduleStaff').value = '';
            document.getElementById('scheduleCustomerName').value = '';
            document.getElementById('scheduleMenu').value = '';
            document.getElementById('scheduleNotes').value = '';
            
            document.getElementById('scheduleModal').showModal();
        }

        // 週表示用のスケジュール追加モーダル
        function openWeekScheduleModal(date, time) {
            document.getElementById('scheduleDate').value = date;
            document.getElementById('scheduleTime').value = time;
            
            // フォームをリセット
            document.getElementById('scheduleStaff').value = '';
            document.getElementById('scheduleCustomerName').value = '';
            document.getElementById('scheduleMenu').value = '';
            document.getElementById('scheduleNotes').value = '';
            
            // モーダルを開く
            document.getElementById('scheduleModal').showModal();
        }

        // 月表示用のスケジュール追加モーダル
        function openMonthScheduleModal(date) {
            document.getElementById('scheduleDate').value = date;
            document.getElementById('scheduleTime').value = '10:00'; // デフォルト時間
            
            // フォームをリセット
            document.getElementById('scheduleStaff').value = '';
            document.getElementById('scheduleCustomerName').value = '';
            document.getElementById('scheduleMenu').value = '';
            document.getElementById('scheduleNotes').value = '';
            
            // モーダルを開く
            document.getElementById('scheduleModal').showModal();
        }
        
        function saveSchedule() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const staff = document.getElementById('scheduleStaff').value;
            const customerName = document.getElementById('scheduleCustomerName').value;
            const menu = document.getElementById('scheduleMenu').value;
            const notes = document.getElementById('scheduleNotes').value;
            const durationSel = document.getElementById('treatmentDuration');
            const duration = durationSel ? parseInt(durationSel.value, 10) : 60;
            
            if (!customerName.trim()) {
                alert('お客様名は必須項目です。');
                return;
            }
            
            if (!staff) {
                alert('担当者を選択してください。');
                return;
            }
            
            // スケジュールデータを保存
            const scheduleData = {
                date: date,
                time: time,
                staff: staff,
                customerName: customerName,
                menu: menu,
                notes: notes,
                duration: duration
            };
            
            const key = `schedule_${date}_${time}`;
            localStorage.setItem(key, JSON.stringify(scheduleData));
            
            console.log('スケジュール保存:', scheduleData);
            alert('スケジュールを登録しました。');
            
            // モーダルを閉じる
            document.getElementById('scheduleModal').close();
            
            // スケジュール表示を更新
            updateScheduleView();
            // 旧モーダル閉却
            const old = document.getElementById('newReservationModal');
            if (old && old.close) old.close();
        }
        
        // 保存されたスケジュールを表示（任意長対応）
        function loadSavedSchedules() {
            const currentDateStr = formatLocalDate(currentDate);
            const rows = document.querySelectorAll('#scheduleTableBody tr');
            // 既存のevent-blockを掃除
            document.querySelectorAll('.event-block').forEach(n => n.remove());
            
            // localStorageから当日分を走査
            Object.keys(localStorage).forEach(key => {
                if (!key.startsWith(`schedule_${currentDateStr}_`)) return;
                try {
                    const scheduleData = JSON.parse(localStorage.getItem(key));
                    if (!scheduleData || !scheduleData.time) return;
                    renderEventBlock(scheduleData);
                } catch {}
            });
        }

        function renderEventBlock(scheduleData) {
            // 行を特定（開始時刻の行：時を切り出してHH:00に一致させる）
            const [th, tm] = scheduleData.time.split(':').map(Number);
            const baseRowTime = `${String(th).padStart(2,'0')}:00`;
            const row = Array.from(document.querySelectorAll('#scheduleTableBody tr'))
                .find(tr => (tr.children[0] && tr.children[0].textContent.trim() === baseRowTime));
            if (!row) return;

            // 表示モードに応じて列を決定
            const viewType = document.querySelector('input[name="view"]:checked')?.value || 'all';
            const staffOrder = ['tanaka','yamada','sato','suzuki'];
            let colIdx = 1; // デフォルトは部屋列
            if (viewType === 'all') {
                const idx = staffOrder.indexOf((scheduleData.staff || '').toLowerCase());
                colIdx = 2 + (idx >= 0 ? idx : 0);
            } else if (viewType === 'staff') {
                const staffFilter = document.getElementById('staffFilter')?.value || '';
                if (staffFilter) {
                    colIdx = 1; // 単一スタッフ表示
                } else {
                    const idx = staffOrder.indexOf((scheduleData.staff || '').toLowerCase());
                    colIdx = 1 + (idx >= 0 ? idx : 0);
                }
            } else if (viewType === 'room') {
                colIdx = 1; // 部屋列のみ
            }
            if (colIdx >= row.children.length) colIdx = row.children.length - 1;
            const cell = row.children[colIdx];
            const cellInner = cell.querySelector('.day-hour-cell') || cell;
            const [h, m] = scheduleData.time.split(':').map(Number);
            const duration = parseInt(scheduleData.duration || '60', 10); // 分

            // セルの開始時刻（行のラベル）
            const [baseH, baseM] = (row.children[0].textContent.trim()).split(':').map(Number);
            const startOffsetMin = (h - baseH) * 60 + (m - baseM);
            const endOffsetMin = startOffsetMin + duration;
            const pxPerMin = 120 / 60; // 120pxが60分

            const top = Math.max(0, startOffsetMin * pxPerMin);
            const height = Math.max(24, endOffsetMin * pxPerMin - top); // 最小高さ確保
            const staffClass = `staff-${scheduleData.staff || 'tanaka'}`;

            const block = document.createElement('div');
            block.className = `event-block ${staffClass}`;
            block.style.top = `${top}px`;
            block.style.height = `${height}px`;
            block.dataset.name = scheduleData.customerName || '';
            block.dataset.time = `${scheduleData.time} - ${getEndTime(scheduleData.time, duration)}`;
            block.dataset.menu = scheduleData.menu || '';
            block.onmouseover = (e) => showReservationTooltip(block, e);
            block.onmouseout = () => hideReservationTooltip();
            block.addEventListener('click', function(e) {
                e.stopPropagation();
                openPatientChart(scheduleData.customerName || '', scheduleData.date, scheduleData.time);
            });
            block.innerHTML = `
                <div class="text-sm font-semibold mb-1">予約あり</div>
                <div class="text-xs mb-1">${scheduleData.time} - ${getEndTime(scheduleData.time, duration)}</div>
                <div class="text-xs mb-1">${getStaffName(scheduleData.staff)}</div>
                ${scheduleData.menu ? `<div class=\"text-xs mb-1\">${scheduleData.menu}</div>` : ''}
                ${scheduleData.notes ? `<div class=\"text-xs opacity-90\">${scheduleData.notes}</div>` : ''}
            `;
            cellInner.appendChild(block);
        }
        
        function getStaffName(staffId) {
            const staffNames = {
                'tanaka': '田中 太郎',
                'yamada': '山田 花子',
                'sato': '佐藤 次郎',
                'suzuki': '鈴木 美咲',
                'equipment': '機器・設備'
            };
            return staffNames[staffId] || staffId;
        }

        // 今日ボタンの機能
        function goToToday() {
            currentDate = new Date();
            updateDatePicker();
            updateDateDisplay();
            updateScheduleView();
            saveViewState();
        }

        // 新規顧客登録関連の関数
        function openNewCustomerModal() {
            // 新規顧客登録モーダルを開く
            alert('新規顧客登録機能は準備中です');
        }

        // 新規予約登録関連の関数
        function openNewReservationModal() {
            // 現在の日付をデフォルトに設定
            const today = formatLocalDate(currentDate);
            document.getElementById('reservationDate').value = today;
            document.getElementById('reservationTime').value = '10:00';
            
            document.getElementById('newReservationModal').showModal();
        }

        // 時間枠クリックで予約追加
        function openTimeSlotReservation(time) {
            const today = formatLocalDate(currentDate);
            document.getElementById('reservationDate').value = today;
            document.getElementById('reservationTime').value = time;
            
            document.getElementById('newReservationModal').showModal();
        }

        // 予約詳細ツールチップ表示
        function showReservationTooltip(element, event) {
            const tooltip = document.getElementById('reservationTooltip');
            const rect = element.getBoundingClientRect();
            
            // elementから安全に情報を取得（data属性優先、なければDOM）
            const patientName = element.dataset.name || element.querySelector('.font-semibold')?.textContent || '';
            const dataTime = element.dataset.time || '';
            const timeText = dataTime || element.querySelector('.font-medium')?.textContent || element.querySelector('.text-xs')?.textContent || '';
            const menuText = element.dataset.menu || element.querySelector('.opacity-90')?.textContent || '';

            document.getElementById('tooltipPatientName').textContent = patientName || '予約';
            document.getElementById('tooltipTime').textContent = timeText || '--:--';
            document.getElementById('tooltipMenu').textContent = menuText || '';
            document.getElementById('tooltipAge').textContent = '';
            document.getElementById('tooltipVisitType').textContent = '';
            document.getElementById('tooltipPhone').textContent = '';
            document.getElementById('tooltipNotes').textContent = '';

            currentTooltipData = {
                name: patientName,
                time: timeText,
                menu: menuText
            };
            
            tooltip.style.left = (rect.right + 10) + 'px';
            tooltip.style.top = rect.top + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideReservationTooltip() {
            document.getElementById('reservationTooltip').classList.add('hidden');
        }

        function editReservationFromTooltip() {
            hideReservationTooltip();
            openPatientChart(currentTooltipData.name, formatLocalDate(currentDate), currentTooltipData.time);
        }

        // カルテモーダル関連の関数
        function openPatientChart(patientName, date, time) {
            // カルテモーダルにデータを設定
            const startDateTime = date + 'T' + time;
            document.getElementById('chartStartTime').value = startDateTime;
            
            // 終了時間はメニュー選択に応じて自動計算（初期値は60分）
            const start = new Date(startDateTime);
            let duration = 60;
            const menuSel = document.getElementById('chartMenu');
            const applyEnd = () => {
                const end = new Date(start);
                end.setMinutes(end.getMinutes() + duration);
                document.getElementById('chartEndTime').value = end.toISOString().slice(0, 16);
            };
            // 初期適用
            applyEnd();
            // メニュー変更時に再計算
            if (menuSel && !menuSel._bindDuration) {
                menuSel.addEventListener('change', () => {
                    const v = menuSel.value;
                    if (v === 'basic30') duration = 30;
                    else if (v === 'standard60') duration = 60;
                    else if (v === 'premium90') duration = 90;
                    else if (v === 'fullbody120') duration = 120;
                    else duration = 60;
                    applyEnd();
                });
                menuSel._bindDuration = true;
            }
            
            // 顧客名をテキスト入力に反映（自由入力）
            const customerInput = document.getElementById('chartCustomerName');
            if (customerInput) {
                customerInput.value = patientName || '';
            }
            
            // サンプルデータを設定
            document.getElementById('chartCustomerId').value = '688';
            document.getElementById('chartNotes').value = '早整体を6.0分で施術しますが内容的に疲れだのでゆっくり口コースにしてください';
            document.getElementById('chartCustomerNotes').value = '実際に三宮から高速へ 2階5階のお客さん';
            
            // 新規予約モーダルが開いていたら閉じる
            const newModal = document.getElementById('newReservationModal');
            if (newModal && typeof newModal.close === 'function') {
                try { newModal.close(); } catch {}
            }
            document.getElementById('patientChartModal').showModal();
        }

        function savePatientChart() {
            const startStr = document.getElementById('chartStartTime').value; // YYYY-MM-DDTHH:MM
            const start = new Date(startStr);
            const menuSelect = document.getElementById('chartMenu');
            const menuText = menuSelect?.options[menuSelect.selectedIndex]?.textContent || '';
            const menuVal = menuSelect?.value || '';
            let duration = 60;
            if (menuVal === 'basic30') duration = 30;
            else if (menuVal === 'standard60') duration = 60;
            else if (menuVal === 'premium90') duration = 90;
            else if (menuVal === 'fullbody120') duration = 120;
            const end = new Date(start);
            end.setMinutes(end.getMinutes() + duration);
            document.getElementById('chartEndTime').value = end.toISOString().slice(0, 16);

            const customerInput = document.getElementById('chartCustomerName');
            const customerName = (customerInput?.value || '').trim();
            const optionSelect = document.getElementById('chartOptionMenu');
            const optionText = optionSelect?.options[optionSelect.selectedIndex]?.textContent || '';
            const staff = (document.getElementById('chartStaff').value || '').toLowerCase();

            const date = startStr.slice(0, 10);
            const time = startStr.slice(11, 16);

            const scheduleData = {
                date: date,
                time: time,
                staff: staff,
                customerName: customerName,
                menu: optionText && optionSelect.value ? `${menuText} / ${optionText}` : menuText,
                notes: document.getElementById('chartNotes').value || document.getElementById('chartCustomerNotes').value || '',
                duration: duration
            };

            // 保存
            const key = `schedule_${date}_${time}`;
            localStorage.setItem(key, JSON.stringify(scheduleData));

            // モーダルを閉じて即時反映
            document.getElementById('patientChartModal').close();
            if (typeof updateScheduleView === 'function') {
                updateScheduleView();
            } else if (typeof loadSavedSchedules === 'function') {
                loadSavedSchedules();
            }
        }

        // スケジュール（カルテ）をキャンセル→非表示
        function cancelSchedule() {
            // chartStartTimeから日付と時間を抽出
            const start = document.getElementById('chartStartTime').value;
            if (start) {
                try {
                    const [date, timeFull] = start.split('T');
                    const time = timeFull?.slice(0,5);
                    if (date && time) {
                        const key = `schedule_${date}_${time}`;
                        localStorage.removeItem(key);
                    }
                } catch {}
            }
            // モーダルを閉じて表示を更新
            document.getElementById('patientChartModal').close();
            if (typeof updateScheduleView === 'function') {
                updateScheduleView();
            } else if (typeof loadSavedSchedules === 'function') {
                loadSavedSchedules();
            }
        }

        function saveNewReservation() {
            const customerName = document.getElementById('customerName').value.trim();
            const reservationDate = document.getElementById('reservationDate').value;
            const reservationTime = document.getElementById('reservationTime').value;
            
            // 必須項目チェック
            if (!customerName) {
                alert('お客様名は必須項目です。');
                document.getElementById('customerName').focus();
                return false; // モーダルを閉じない
            }
            
            if (!reservationDate) {
                alert('予約日は必須項目です。');
                document.getElementById('reservationDate').focus();
                return false; // モーダルを閉じない
            }
            
            if (!reservationTime) {
                alert('予約時間は必須項目です。');
                document.getElementById('reservationTime').focus();
                return false; // モーダルを閉じない
            }
            
            // ここで実際の保存処理を行う
            const reservationData = {
                customerName: customerName,
                phone: document.getElementById('customerPhone').value,
                age: document.getElementById('customerAge').value,
                gender: document.getElementById('customerGender').value,
                visitType: document.querySelector('input[name="visitType"]:checked').value,
                date: reservationDate,
                time: reservationTime,
                duration: document.getElementById('treatmentDuration').value,
                staff: document.getElementById('assignedStaff').value,
                menu: document.getElementById('treatmentMenu').value,
                notes: document.getElementById('reservationNotes').value
            };
            
            // 保存（localStorage）
            const key = `schedule_${reservationDate}_${reservationTime}`;
            localStorage.setItem(key, JSON.stringify({
                date: reservationDate,
                time: reservationTime,
                staff: reservationData.staff || 'tanaka',
                customerName: reservationData.customerName,
                menu: reservationData.menu,
                notes: reservationData.notes,
                duration: parseInt(reservationData.duration || '60', 10)
            }));
            
            // モーダルを閉じる
            document.getElementById('newReservationModal').close();
            
            // 画面更新（即時反映）
            if (typeof updateScheduleView === 'function') {
            updateScheduleView();
            } else if (typeof loadSavedSchedules === 'function') {
                loadSavedSchedules();
            }

            // フォームをリセット
            resetReservationForm();
            
            return true;
        }

        function resetReservationForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAge').value = '';
            document.getElementById('customerGender').value = '';
            document.querySelector('input[name="visitType"][value="first"]').checked = true;
            document.getElementById('treatmentDuration').value = '30';
            document.getElementById('assignedStaff').value = '';
            document.getElementById('treatmentMenu').value = '';
            document.getElementById('reservationNotes').value = '';
        }

        function updateScheduleDisplay() {
            // 実際の実装では、サーバーからスケジュールデータを取得して表示を更新
            console.log('スケジュール表示を更新');
        }

        // デイリーメモ関連の関数
        function closeDailyMemo() {
            document.getElementById('dailyMemoSidebar').classList.add('hidden');
        }

        function openDailyMemo() {
            document.getElementById('dailyMemoSidebar').classList.remove('hidden');
        }

        // モーダル関連の関数
        function openNewProviderModal() {
            document.getElementById('newProviderModal').showModal();
        }

        function openEditProviderModal(name, type) {
            const modal = document.getElementById('editProviderModal');
            const nameInput = document.getElementById('editProviderName');
            const typeIcon = document.getElementById('editProviderTypeIcon');
            const typeText = document.getElementById('editProviderTypeText');
            
            // 名前を設定
            nameInput.value = name;
            
            // タイプに応じてアイコンとテキストを設定
            if (type === 'staff') {
                typeIcon.innerHTML = '<i class="fas fa-user text-sm text-white"></i>';
                typeIcon.className = 'w-8 h-8 rounded-full bg-primary flex items-center justify-center';
                typeText.textContent = 'スタッフ';
                
                // スタッフのサンプルデータ
                document.getElementById('editCustomerCount').textContent = '419';
                document.getElementById('editMonthlyCharts').textContent = '82';
                document.getElementById('editNewCustomers').textContent = '15';
                document.getElementById('editRepeatRate').textContent = '14%';
                document.getElementById('editTargetRepeatRate').value = '20';
            } else if (type === 'equipment') {
                typeIcon.innerHTML = '<i class="fas fa-dumbbell text-sm text-base-content"></i>';
                typeIcon.className = 'w-8 h-8 rounded-full bg-base-300 flex items-center justify-center';
                typeText.textContent = '機器・設備';
                
                // 機器のサンプルデータ
                document.getElementById('editCustomerCount').textContent = '15';
                document.getElementById('editMonthlyCharts').textContent = '12';
                document.getElementById('editNewCustomers').textContent = '0';
                document.getElementById('editRepeatRate').textContent = '33%';
                document.getElementById('editTargetRepeatRate').value = '40';
            }
            
            modal.showModal();
        }

        function saveNewProvider() {
            const type = document.getElementById('providerType').value;
            const name = document.getElementById('providerName').value;
            const description = document.getElementById('providerDescription').value;
            const initialCustomers = document.getElementById('initialCustomers').value;
            const targetRepeatRate = document.getElementById('targetRepeatRate').value;
            
            if (!type || !name) {
                alert('タイプと名前は必須項目です。');
                return;
            }
            
            // ここで実際の保存処理を行う
            console.log('新規登録:', { type, name, description, initialCustomers, targetRepeatRate });
            
            // 成功メッセージ
            alert('サービス提供者を登録しました。');
            
            // フォームをリセット
            document.getElementById('providerType').value = '';
            document.getElementById('providerName').value = '';
            document.getElementById('providerDescription').value = '';
            document.getElementById('initialCustomers').value = '0';
            document.getElementById('targetRepeatRate').value = '50';
            
            // モーダルを閉じる
            document.getElementById('newProviderModal').close();
        }

        function saveEditProvider() {
            const name = document.getElementById('editProviderName').value;
            const description = document.getElementById('editProviderDescription').value;
            const targetRepeatRate = document.getElementById('editTargetRepeatRate').value;
            const status = document.getElementById('editProviderStatus').value;
            
            if (!name) {
                alert('名前は必須項目です。');
                return;
            }
            
            // ここで実際の更新処理を行う
            console.log('更新:', { name, description, targetRepeatRate, status });
            
            // 成功メッセージ
            alert('サービス提供者を更新しました。');
            
            // モーダルを閉じる
            document.getElementById('editProviderModal').close();
        }

        function deleteProvider() {
            const name = document.getElementById('editProviderName').value;
            
            if (confirm(`「${name}」を削除してもよろしいですか？\nこの操作は取り消せません。`)) {
                // ここで実際の削除処理を行う
                console.log('削除:', name);
                
                // 成功メッセージ
                alert('サービス提供者を削除しました。');
                
                // モーダルを閉じる
                document.getElementById('editProviderModal').close();
            }
        }

        // 来店数グラフ
        const visitCtx = document.getElementById('visitChart').getContext('2d');
        const visitChart = new Chart(visitCtx, {
            type: 'line',
            data: {
                labels: ['01日', '02日', '03日', '04日', '05日', '06日', '07日', '08日', '09日', '10日', '11日', '12日', '13日', '14日', '15日', '16日', '17日', '18日', '19日', '20日', '21日', '22日', '23日', '24日', '25日', '26日', '27日', '28日', '29日', '30日', '31日'],
                datasets: [{
                    label: '来店数',
                    data: [1, 7, 11, 16, 28, 32, 38, 39, 46, 53, 62, 71, 87, 88, 92, 94, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    borderColor: '#06b6d4',
                    backgroundColor: '#06b6d4',
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // メニュー別円グラフ
        const menuCtx = document.getElementById('menuChart').getContext('2d');
        const menuChart = new Chart(menuCtx, {
            type: 'doughnut',
            data: {
                labels: ['30分コース', '60分コース', '60分+ボディ', '100分コース', '初回限定', 'その他'],
                datasets: [{
                    data: [35, 25, 15, 10, 8, 7],
                    backgroundColor: [
                        '#10b981',
                        '#06b6d4',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6',
                        '#6366f1'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 年齢別円グラフ
        const ageCtx = document.getElementById('ageChart').getContext('2d');
        const ageChart = new Chart(ageCtx, {
            type: 'doughnut',
            data: {
                labels: ['未記入', '0-9歳', '10-19歳', '20-29歳', '30-39歳', '40-49歳', '50-59歳', '60歳-'],
                datasets: [{
                    data: [5, 8, 12, 15, 25, 20, 10, 5],
                    backgroundColor: [
                        '#10b981',
                        '#06b6d4',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6',
                        '#3b82f6',
                        '#6366f1',
                        '#06b6d4'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 流入経路別円グラフ
        const inflowCtx = document.getElementById('inflowChart').getContext('2d');
        const inflowChart = new Chart(inflowCtx, {
            type: 'doughnut',
            data: {
                labels: ['未記入'],
                datasets: [{
                    data: [100],
                    backgroundColor: ['#10b981']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 症状別円グラフ
        const symptomsCtx = document.getElementById('symptomsChart').getContext('2d');
        const symptomsChart = new Chart(symptomsCtx, {
            type: 'doughnut',
            data: {
                labels: ['未記入'],
                datasets: [{
                    data: [100],
                    backgroundColor: ['#10b981']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    </script>

    <script>
        // 簡易データと表示
        function getQuestionnaires(){
            try{ return JSON.parse(localStorage.getItem('questionnaires')||'[]'); }catch{return []}
        }
        function setQuestionnaires(v){ localStorage.setItem('questionnaires', JSON.stringify(v)); }
        function openNewQuestionnaireModal(){ document.getElementById('newQuestionnaireModal').showModal(); }
        function saveNewQuestionnaire(){
            const name = document.getElementById('qnName').value.trim();
            const purpose = document.getElementById('qnPurpose').value.trim();
            if(!name||!purpose){ alert('問診票名と用途は必須です'); return; }
            const list = getQuestionnaires();
            const id = Date.now();
            const url = `https://carecle.com/questionnaire/new?clinic_id=1794&purpose=${encodeURIComponent(purpose)}`;
            list.push({id,name,purpose,url});
            setQuestionnaires(list);
            document.getElementById('newQuestionnaireModal').close();
            renderQuestionnaires();
            // 編集画面のプルダウンも最新化
            populateQuestionnaireOptions();
        }
        function renderQuestionnaires(){
            const tbody = document.getElementById('questionnaireTableBody');
            if(!tbody) return;
            let data = getQuestionnaires();
            if(data.length===0){
                data = [
                    { id:1, name:'痛み・しびれのケア', purpose:'numbness_care', url:'https://carecle.com/questionnaire/new?clinic_id=1794&purpose=numbness_care' },
                    { id:2, name:'交通事故後治療', purpose:'accident_treatment', url:'https://carecle.com/questionnaire/new?clinic_id=1794&purpose=accident_treatment' },
                    { id:3, name:'一般鍼灸治療', purpose:'general_acupuncture', url:'https://carecle.com/questionnaire/new?clinic_id=1794&purpose=general_acupuncture' },
                    { id:4, name:'美容鍼灸', purpose:'beauty_eyebrow', url:'https://carecle.com/questionnaire/new?clinic_id=1794&purpose=beauty_eyebrow' },
                ];
                setQuestionnaires(data);
            }
            tbody.innerHTML = data.map((q,i)=>`
                <tr>
                    <td>${i+1}</td>
                    <td>${q.name}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <span class="truncate max-w-[420px] text-sm">${q.url}</span>
                            <button class="btn btn-xs" onclick="navigator.clipboard.writeText('${q.url}')">URLをコピー</button>
                        </div>
                    </td>
                    <td>
                        <img class="w-24 h-24 object-contain" alt="QR"
                             src="https://quickchart.io/qr?size=120&text=${encodeURIComponent('https://tortoise-programmer.com/')}" />
                    </td>
                    <td>
                        <button class="btn btn-outline btn-xs" onclick="openQuestionnaireDetail(${q.id})">詳細を見る</button>
                    </td>
                </tr>
            `).join('');
            // ひとまず固定の画像QR（tortoise-programmer.com）を使用
        }
        function drawSimpleQR(canvasId, text){
            const c = document.getElementById(canvasId); if(!c) return; const ctx=c.getContext('2d');
            ctx.fillStyle='#000'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#fff';
            for(let y=8;y<c.height-8;y+=8){ for(let x=8;x<c.width-8;x+=8){ const h=(x*31+y*17+text.length*13)%100; if(h%2===0) ctx.fillRect(x,y,6,6); } }
        }
        
        let currentQuestionnaireId = null;
        function openQuestionnaireDetail(id){
            const list = getQuestionnaires();
            const item = list.find(v=>v.id===id);
            const titleEl = document.getElementById('qdTitle');
            if(titleEl){ titleEl.textContent = item ? item.name : '問診票詳細'; }
            currentQuestionnaireId = id;
            loadBodyPositions();
            setupBodyMapClick();
            populateBirthSelectors();
            loadQuestionnaireForm();
            showQuestionnaireDetail();
        }
        function closeQuestionnaireDetail(){}
        function saveBodyPositions(){
            // 任意クリックマーカーを保存（%位置）
            const area = document.getElementById('qdClickableArea');
            if(!area) return;
            const markers = Array.from(area.querySelectorAll('.marker'));
            const positions = markers.map(m=>({
                x: parseFloat(m.dataset.x),
                y: parseFloat(m.dataset.y)
            }));
            if(currentQuestionnaireId==null) return;
            localStorage.setItem(`questionnaire_${currentQuestionnaireId}_points`, JSON.stringify(positions));
            alert('選択箇所を保存しました');
        }
        function loadBodyPositions(){
            // 旧データ（チェックボックス）互換は無視して、ポイントデータを復元
            const area = document.getElementById('qdClickableArea');
            if(!area) return;
            // 既存マーカー削除
            area.querySelectorAll('.marker').forEach(el=>el.remove());
            let positions = [];
            if(currentQuestionnaireId!=null){
                try{ positions = JSON.parse(localStorage.getItem(`questionnaire_${currentQuestionnaireId}_points`)||'[]'); }catch{}
            }
            positions.forEach(p=> addMarker(area, p.x, p.y));
        }
        function setupBodyMapClick(){
            const area = document.getElementById('qdClickableArea');
            if(!area) return;
            // 二重バインド防止
            area.onclick = function(e){
                // 画像領域相対の%座標を算出
                const rect = area.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                // 近接マーカーがあれば削除、なければ追加（トグル）
                const removed = removeNearbyMarker(area, x, y, 3);
                if(!removed){ addMarker(area, x, y); }
            }
        }
        function saveQuestionnaireFormAndPoints(){
            if(currentQuestionnaireId==null){ alert('問診票IDが不明です'); return; }
            // ポイントは既存のsaveBodyPositions相当を内部で呼ぶ
            const area = document.getElementById('qdClickableArea');
            if(area){
                const markers = Array.from(area.querySelectorAll('.marker'));
                const positions = markers.map(m=>({ x: parseFloat(m.dataset.x), y: parseFloat(m.dataset.y) }));
                localStorage.setItem(`questionnaire_${currentQuestionnaireId}_points`, JSON.stringify(positions));
            }
            // フォーム値
            const data = {
                lastName: document.getElementById('qd_lastName')?.value||'',
                firstName: document.getElementById('qd_firstName')?.value||'',
                kanaLast: document.getElementById('qd_kanaLast')?.value||'',
                kanaFirst: document.getElementById('qd_kanaFirst')?.value||'',
                gender: (document.querySelector('input[name="qd_gender"]:checked')?.value)||'',
                email: document.getElementById('qd_email')?.value||'',
                phone: document.getElementById('qd_phone')?.value||'',
                birthY: document.getElementById('qd_birthY')?.value||'',
                birthM: document.getElementById('qd_birthM')?.value||'',
                birthD: document.getElementById('qd_birthD')?.value||'',
                zip: document.getElementById('qd_zip')?.value||'',
                severity: Array.from(document.querySelectorAll('input[name="qd_severity"]:checked')).map(el=>el.value),
                onset: (document.querySelector('input[name="qd_onset"]:checked')?.value)||'',
                trigger: (document.querySelector('input[name="qd_trigger"]:checked')?.value)||'',
                triggerNote: document.getElementById('qd_trigger_note')?.value||'',
                pain: document.getElementById('qd_pain')?.value||'',
                hospital: (document.querySelector('input[name="qd_hospital"]:checked')?.value)||'',
                history: (document.querySelector('input[name="qd_history"]:checked')?.value)||'',
                historyNote: document.getElementById('qd_history_note')?.value||'',
                pastclinic: (document.querySelector('input[name="qd_pastclinic"]:checked')?.value)||'',
                bp: (document.querySelector('input[name="qd_bp"]:checked')?.value)||'',
                pacemaker: (document.querySelector('input[name="qd_pacemaker"]:checked')?.value)||'',
                lowfreq: (document.querySelector('input[name="qd_lowfreq"]:checked')?.value)||'',
                allergy: (document.querySelector('input[name="qd_allergy"]:checked')?.value)||'',
                allergyNote: document.getElementById('qd_allergy_note')?.value||''
            };
            localStorage.setItem(`questionnaire_${currentQuestionnaireId}_form`, JSON.stringify(data));
            alert('入力内容を保存しました');
        }
        function loadQuestionnaireForm(){
            if(currentQuestionnaireId==null) return;
            let data = null;
            try{ data = JSON.parse(localStorage.getItem(`questionnaire_${currentQuestionnaireId}_form`)||'null'); }catch{}
            if(!data) return;
            const setVal = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v||''; };
            setVal('qd_lastName', data.lastName);
            setVal('qd_firstName', data.firstName);
            setVal('qd_kanaLast', data.kanaLast);
            setVal('qd_kanaFirst', data.kanaFirst);
            if(data.gender){ const el=document.querySelector(`input[name="qd_gender"][value="${data.gender}"]`); if(el) el.checked=true; }
            setVal('qd_email', data.email);
            setVal('qd_phone', data.phone);
            populateBirthSelectors();
            setVal('qd_birthY', data.birthY);
            setVal('qd_birthM', data.birthM);
            setVal('qd_birthD', data.birthD);
            setVal('qd_zip', data.zip);
            if(Array.isArray(data.severity)){
                const set = new Set(data.severity);
                document.querySelectorAll('input[name="qd_severity"]').forEach(el=>{ el.checked = set.has(el.value); });
            }
            if(data.onset){ const el=document.querySelector(`input[name="qd_onset"][value="${data.onset}"]`); if(el) el.checked=true; }
            if(data.trigger){ const el=document.querySelector(`input[name="qd_trigger"][value="${data.trigger}"]`); if(el) el.checked=true; }
            setVal('qd_trigger_note', data.triggerNote);
            if(data.pain){ const h=document.getElementById('qd_pain'); if(h){ h.value=data.pain; highlightPainButtons(parseInt(data.pain,10)); } }
            if(data.hospital){ const el=document.querySelector(`input[name="qd_hospital"][value="${data.hospital}"]`); if(el) el.checked=true; }
            if(data.history){ const el=document.querySelector(`input[name="qd_history"][value="${data.history}"]`); if(el) el.checked=true; }
            setVal('qd_history_note', data.historyNote);
            if(data.pastclinic){ const el=document.querySelector(`input[name="qd_pastclinic"][value="${data.pastclinic}"]`); if(el) el.checked=true; }
            if(data.bp){ const el=document.querySelector(`input[name="qd_bp"][value="${data.bp}"]`); if(el) el.checked=true; }
            if(data.pacemaker){ const el=document.querySelector(`input[name="qd_pacemaker"][value="${data.pacemaker}"]`); if(el) el.checked=true; }
            if(data.lowfreq){ const el=document.querySelector(`input[name="qd_lowfreq"][value="${data.lowfreq}"]`); if(el) el.checked=true; }
            if(data.allergy){ const el=document.querySelector(`input[name="qd_allergy"][value="${data.allergy}"]`); if(el) el.checked=true; }
            setVal('qd_allergy_note', data.allergyNote);
        }
        function populateBirthSelectors(){
            const ySel=document.getElementById('qd_birthY'); const mSel=document.getElementById('qd_birthM'); const dSel=document.getElementById('qd_birthD');
            if(!ySel||!mSel||!dSel) return;
            if(ySel.options.length===0){
                const now=new Date().getFullYear();
                for(let y=now; y>=1900; y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); ySel.appendChild(o); }
            }
            if(mSel.options.length===0){ for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=String(m).padStart(2,'0'); mSel.appendChild(o);} }
            if(dSel.options.length===0){ for(let d=1;d<=31;d++){ const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=String(d).padStart(2,'0'); dSel.appendChild(o);} }
        }
        // --- 問診票ビルダー ---
        function initQuestionnaireBuilder(){
            // 下書きがあれば読み込む、なければ基本テンプレ
            let draft = null;
            try{ draft = JSON.parse(localStorage.getItem('qn_builder_draft')||'null'); }catch{}
            if(draft){ renderBuilder(draft); }
            else { loadBuilderFromTemplate('basic'); }
        }
        function loadBuilderFromTemplate(name){
            const templates = {
                basic: [
                    {type:'text', label:'お名前', required:true, key:'name'},
                    {type:'phone', label:'電話番号', required:false, key:'phone'},
                    {type:'radio', label:'性別', options:['男性','女性','回答しない','その他'], key:'gender'},
                    {type:'checkbox', label:'現在の症状', options:['肩こり','腰痛','頭痛','膝痛','しびれ','その他'], key:'symptoms'},
                    {type:'pain', label:'痛みの強さ', key:'pain'},
                    {type:'bodymap', label:'症状の出ている箇所', key:'body_positions'},
                    {type:'textarea', label:'気になること・メモ', key:'note'}
                ],
                orthopedic: [
                    {type:'text', label:'お名前', required:true, key:'name'},
                    {type:'date', label:'受傷日', key:'injury_date'},
                    {type:'radio', label:'受傷原因', options:['転倒','交通事故','スポーツ','不明'], key:'cause'},
                    {type:'checkbox', label:'症状部位', options:['首','肩','肘','腰','股関節','膝','足首'], key:'area'},
                    {type:'pain', label:'痛みの強さ', key:'pain'},
                    {type:'textarea', label:'詳細', key:'detail'}
                ],
                acupuncture: [
                    {type:'text', label:'お名前', required:true, key:'name'},
                    {type:'checkbox', label:'主訴', options:['肩こり','腰痛','頭痛','不眠','冷え','疲労感'], key:'main'},
                    {type:'radio', label:'体質', options:['寒がり','暑がり','むくみやすい','便秘がち'], key:'constitution'},
                    {type:'bodymap', label:'気になる箇所', key:'body_positions'},
                    {type:'pain', label:'痛みの強さ', key:'pain'}
                ]
            };
            const schema = templates[name] || templates.basic;
            renderBuilder(schema);
        }
        function renderBuilder(schema){
            const preview = document.getElementById('builderPreview');
            if(!preview) return;
            preview.innerHTML = '';
            schema.forEach((f,idx)=> preview.appendChild(buildFieldEditor(f, idx)) );
            preview.dataset.schema = JSON.stringify(schema);
        }
        function buildFieldEditor(field, index){
            const wrap = document.createElement('div');
            wrap.className = 'p-3 rounded border border-base-300';
            wrap.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="font-semibold">${escapeHtml(field.label||'未設定')} <span class="text-xs text-base-content/60">(${field.type})</span></div>
                    <div class="flex gap-2">
                        <button class="btn btn-xs" type="button" data-action="edit">編集</button>
                        <button class="btn btn-xs btn-error btn-outline" type="button" data-action="delete">削除</button>
                    </div>
                </div>
                <div class="text-sm text-base-content/70">キー: ${field.key||'-'}</div>
            `;
            wrap.querySelector('[data-action="edit"]').onclick = ()=> openFieldModal(field, index);
            wrap.querySelector('[data-action="delete"]').onclick = ()=> removeField(index);
            return wrap;
        }
        function addField(type){
            const preview = document.getElementById('builderPreview');
            const schema = JSON.parse(preview.dataset.schema||'[]');
            const newField = {type, label: defaultLabel(type), key: uniqueKey(type)};
            if(type==='radio'||type==='checkbox'||type==='select') newField.options=['選択肢1','選択肢2'];
            schema.push(newField);
            renderBuilder(schema);
        }
        function removeField(index){
            const preview = document.getElementById('builderPreview');
            const schema = JSON.parse(preview.dataset.schema||'[]');
            schema.splice(index,1);
            renderBuilder(schema);
        }
        function openFieldModal(field, index){
            const label = prompt('項目名を入力してください', field.label||'');
            if(label===null) return; field.label = label.trim();
            if(field.type==='radio'||field.type==='checkbox'||field.type==='select'){
                const opts = prompt('選択肢（カンマ区切り）', (field.options||[]).join(','));
                if(opts!==null){ field.options = opts.split(',').map(s=>s.trim()).filter(Boolean); }
            }
            const key = prompt('保存用キー（半角英数・空白不可）', field.key||uniqueKey(field.type));
            if(key!==null && key.trim()){ field.key = key.trim(); }
            const preview = document.getElementById('builderPreview');
            const schema = JSON.parse(preview.dataset.schema||'[]');
            schema[index] = field;
            renderBuilder(schema);
        }
        function defaultLabel(type){
            switch(type){
                case 'text': return 'テキスト';
                case 'textarea': return '自由記述';
                case 'radio': return '単一選択';
                case 'checkbox': return '複数選択';
                case 'select': return 'プルダウン';
                case 'pain': return '痛みの強さ';
                case 'bodymap': return '人体クリック';
                case 'date': return '日付';
                case 'phone': return '電話番号';
                default: return '項目';
            }
        }
        function uniqueKey(type){
            const base = `f_${type}_` + Math.random().toString(36).slice(2,7);
            return base;
        }
        function saveBuilderDraft(){
            const preview = document.getElementById('builderPreview');
            const schema = JSON.parse(preview.dataset.schema||'[]');
            localStorage.setItem('qn_builder_draft', JSON.stringify(schema));
            alert('下書きを保存しました');
        }
        function publishQuestionnaire(){
            const preview = document.getElementById('builderPreview');
            const schema = JSON.parse(preview.dataset.schema||'[]');
            const list = getQuestionnaires();
            const id = Date.now();
            const name = prompt('問診票のタイトルを入力してください','新しい問診票');
            const purpose = 'custom';
            const url = `https://carecle.com/questionnaire/new?clinic_id=1794&purpose=custom_${id}`;
            list.push({id, name: (name||'新しい問診票'), purpose, url, schema});
            setQuestionnaires(list);
            localStorage.removeItem('qn_builder_draft');
            alert('公開しました。問診票一覧に追加されました');
            backToQuestionnaires();
            renderQuestionnaires();
        }
        function escapeHtml(str){
            return String(str||'').replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
        }
        function setPainLevel(n){
            const h = document.getElementById('qd_pain');
            if(h){ h.value=String(n); }
            highlightPainButtons(n);
        }
        function highlightPainButtons(n){
            const buttons = document.querySelectorAll('#questionnaireDetailContent .pain-scale .btn');
            buttons.forEach((b,idx)=>{
                const num = idx+1;
                if(num===n){ b.classList.add('btn-primary'); b.classList.remove('btn-ghost'); }
                else { b.classList.add('btn-ghost'); b.classList.remove('btn-primary'); }
            });
        }
        function addMarker(area, x, y){
            const m = document.createElement('div');
            m.className = 'marker';
            m.style.left = x + '%';
            m.style.top = y + '%';
            m.dataset.x = String(x);
            m.dataset.y = String(y);
            m.title = `${Math.round(x)}%, ${Math.round(y)}%`;
            // クリックで自身削除
            m.addEventListener('click', function(ev){ ev.stopPropagation(); m.remove(); });
            area.appendChild(m);
        }
        function removeNearbyMarker(area, x, y, radiusPct){
            const markers = Array.from(area.querySelectorAll('.marker'));
            for(const m of markers){
                const mx = parseFloat(m.dataset.x);
                const my = parseFloat(m.dataset.y);
                const dx = mx - x; const dy = my - y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist <= radiusPct){ m.remove(); return true; }
            }
            return false;
        }
    </script>

    <script>
        function openMenuEdit() {
            hideAllContent();
            const el = document.getElementById('menuEditContent');
            if (el) el.classList.remove('hidden');
            updateActiveMenu('menu');
            populateQuestionnaireOptions();
        }

        function backToMenuList() {
            hideAllContent();
            const el = document.getElementById('menuManagementContent');
            if (el) el.classList.remove('hidden');
            updateActiveMenu('menu');
        }

        function updateTaxIncluded() {
            const price = parseInt((document.getElementById('me_price')?.value || '0').replace(/,/g, ''), 10) || 0;
            const rate = parseInt(document.getElementById('me_tax_rate')?.value || '10', 10);
            const kind = document.getElementById('me_tax_kind')?.value || 'inside';
            let inc = price;
            if (kind === 'outside') {
                inc = Math.round(price * (1 + rate / 100));
            }
            const out = document.getElementById('me_price_inc');
            if (out) out.value = inc.toLocaleString('ja-JP') + '円';
        }

        // 問診票 -> 編集画面の「問診票の紐付け」に反映
        function populateQuestionnaireOptions() {
            const sel = document.getElementById('me_questionnaire');
            if(!sel) return;
            const list = (function(){
                try{ return JSON.parse(localStorage.getItem('questionnaires')||'[]'); }catch{return []}
            })();
            sel.innerHTML = '<option value="">選択してください</option>' +
                list.map(q=>`<option value="${q.id}">${q.name}</option>`).join('');
        }

        // メニュー管理：タブ切り替え
        function switchMenuTab(type) {
            const tabs = {
                menu: { tab: 'tabMenu', section: 'menuListSection' },
                option: { tab: 'tabOption', section: 'optionListSection' },
                goods: { tab: 'tabGoods', section: 'goodsListSection' }
            };
            Object.keys(tabs).forEach(key => {
                const t = document.getElementById(tabs[key].tab);
                const s = document.getElementById(tabs[key].section);
                if (t) t.classList.remove('tab-active');
                if (s) s.classList.add('hidden');
            });
            const active = tabs[type];
            if (active) {
                const t = document.getElementById(active.tab);
                const s = document.getElementById(active.section);
                if (t) t.classList.add('tab-active');
                if (s) s.classList.remove('hidden');
            }
        }

        // メニュー管理：検索（簡易）
        function searchMenus() {
            const input = document.getElementById('menuSearchInput');
            const keyword = (input && input.value ? input.value : '').trim();
            const rows = document.querySelectorAll('#menuListTableBody tr');
            rows.forEach(row => {
                const text = row.cells[1] ? row.cells[1].innerText : '';
                row.classList.toggle('hidden', keyword && !text.includes(keyword));
            });
        }

        // メニュー管理：新規作成（ダミー）
        function createNewMenu() {
            alert('新規作成はダミーです');
        }
    </script>
</body>
</html>

